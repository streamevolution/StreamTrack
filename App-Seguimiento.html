<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Evolution</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- VARIABLES Y ESTILO BASE NEUMÓRFICO --- */
        :root {
            --color-bg-primary: #f0f0f0;
            --color-text-dark: #1F2937;
            --color-accent: #007AFF; /* Azul Minimalista */
            --color-success: #10B981;
            --color-danger: #EF4444;
            --shadow-light: 8px 8px 16px rgba(163, 177, 198, 0.6);
            --shadow-dark: -8px -8px 16px rgba(255, 255, 255, 0.8);
            --shadow-inset-light: inset 5px 5px 10px rgba(163, 177, 198, 0.6);
            --shadow-inset-dark: inset -5px -5px 10px rgba(255, 255, 255, 0.8);
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--color-bg-primary); 
            color: var(--color-text-dark); 
            -webkit-tap-highlight-color: transparent; 
            transition: background-color 0.3s, color 0.3s;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- CLASES NEUMÓRFICAS --- */

        .neumo-card {
            background: var(--color-bg-primary);
            border-radius: 20px;
            box-shadow: var(--shadow-light), var(--shadow-dark);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .neumo-button {
            background: var(--color-bg-primary);
            border-radius: 15px;
            box-shadow: var(--shadow-light), var(--shadow-dark);
            transition: all 0.3s ease;
        }
        
        .neumo-button:hover,
        .neumo-card:hover:not(.neumo-inset):not(.neumo-flat),
        .neumo-button:active {
            box-shadow: var(--shadow-inset-light), var(--shadow-inset-dark);
            transform: scale(0.98);
        }

        .neumo-inset {
            box-shadow: var(--shadow-inset-light), var(--shadow-inset-dark);
            background: var(--color-bg-primary);
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .neumo-flat {
             background: var(--color-bg-primary);
             box-shadow: none;
             border-radius: 0;
        }

        /* --- ANIMACIONES --- */
        .loader-text {
            background: linear-gradient(to right, var(--color-text-dark) 0%, #374151 50%, var(--color-text-dark) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            background-size: 200% auto;
            animation: shine 2.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }
        
        .pulse-ring { 
            animation: pulse-ring 2.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; 
            border: 1px solid rgba(0, 122, 255, 0.3); 
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.7); opacity: 0.6; box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.5); }
            100% { transform: scale(1.3); opacity: 0; box-shadow: 0 0 0 10px rgba(0, 122, 255, 0); }
        }

        .bounce-enter { animation: bounceIn 0.5s cubic-bezier(0.215, 0.610, 0.355, 1.000) both; }
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.95); }
            70% { transform: scale(1.02); }
            100% { opacity: 1; transform: scale(1); }
        }

        .slide-up { animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }

        /* Helpers */
        .bg-accent { background-color: var(--color-accent); }
        .text-accent { color: var(--color-accent); }
        .text-success { color: var(--color-success); }
        .bg-success { background-color: var(--color-success); }
        .text-danger { color: var(--color-danger); }
        .bg-danger { background-color: var(--color-danger); }
        .hidden { display: none !important; }
    </style>
</head>
<body class="text-gray-800 overflow-x-hidden min-h-screen relative bg-bg-primary selection:bg-accent">

    <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <div id="global-loader" class="fixed inset-0 bg-bg-primary z-[90] flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="relative flex items-center justify-center mb-6">
            <div class="absolute w-24 h-24 bg-accent/20 rounded-full pulse-ring"></div>
            <div class="absolute w-16 h-16 bg-accent/40 rounded-full pulse-ring" style="animation-delay: 0.5s;"></div>
            <div class="relative w-12 h-12 bg-gray-900 rounded-2xl shadow-xl flex items-center justify-center text-white font-bold text-xl z-10 neumo-card" style="box-shadow: 5px 5px 10px rgba(0,0,0,0.2);">SE</div>
        </div>
        <div class="text-center space-y-1">
            <h1 class="text-2xl font-black tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-gray-800 via-gray-600 to-gray-800 loader-text">STREAM EVOLUTION</h1>
            <p class="text-[10px] uppercase tracking-[0.3em] text-gray-400 font-medium animate-pulse">Cargando Ecosistema</p>
        </div>
    </div>

    <div id="auth-container" class="min-h-screen flex flex-col items-center justify-center p-6 hidden bg-bg-primary">
        <div class="mb-10 text-center bounce-enter">
            <div class="w-16 h-16 bg-gray-900 rounded-2xl flex items-center justify-center text-white font-bold shadow-2xl text-2xl mx-auto mb-5 transform rotate-3 neumo-card">SE</div>
            <h1 class="text-3xl font-black text-gray-800 tracking-tight">STREAM <span class="text-accent">EVOLUTION</span></h1>
        </div>

        <div class="w-full max-w-sm space-y-6 slide-up" style="animation-delay: 0.1s;">
            <form id="login-form" class="space-y-4 auth-view">
                <div class="relative group neumo-inset">
                    <i data-lucide="mail" class="absolute left-4 top-3.5 w-5 h-5 text-gray-400 transition-colors group-focus-within:text-accent"></i>
                    <input type="email" id="login-email" class="neumo-inset w-full bg-transparent border-none rounded-2xl py-3.5 pl-12 pr-4 text-gray-700 font-medium placeholder:text-gray-400 focus:ring-0 focus:outline-none" placeholder="Correo electrónico" required>
                </div>
                <div class="relative group neumo-inset">
                    <i data-lucide="lock" class="absolute left-4 top-3.5 w-5 h-5 text-gray-400 transition-colors group-focus-within:text-accent"></i>
                    <input type="password" id="login-password" class="neumo-inset w-full bg-transparent border-none rounded-2xl py-3.5 pl-12 pr-4 text-gray-700 font-medium placeholder:text-gray-400 focus:ring-0 focus:outline-none" placeholder="Contraseña" required>
                </div>
                <div class="text-right">
                    <button type="button" onclick="switchAuthView('forgot')" class="text-xs text-gray-500 font-bold hover:text-accent transition-colors">¿Olvidaste tu contraseña?</button>
                </div>
                <button type="submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-gray-800 flex justify-center items-center gap-2 mt-2">
                    <span>Ingresar</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
                <div class="text-center text-sm text-gray-500 mt-6">
                    ¿Nuevo aquí? <button type="button" onclick="switchAuthView('register')" class="text-accent font-bold hover:underline ml-1">Crear Cuenta</button>
                </div>
            </form>

            <form id="register-form" class="space-y-4 hidden auth-view">
                <h2 class="text-xl font-bold text-gray-800 mb-2">Registro</h2>
                <div id="referral-badge" class="hidden bg-indigo-50 text-indigo-600 p-3 rounded-xl text-xs font-bold border border-indigo-100 flex items-center gap-2 neumo-card neumo-flat">
                    <i data-lucide="gift" class="w-4 h-4"></i> <span>¡Te han invitado! Recibe $40 de regalo.</span>
                </div>
                <input type="email" id="reg-email" class="neumo-inset w-full bg-transparent border-none rounded-2xl py-3.5 px-4" placeholder="Correo electrónico" required>
                <input type="password" id="reg-password" class="neumo-inset w-full bg-transparent border-none rounded-2xl py-3.5 px-4" placeholder="Contraseña" required>
                <input type="password" id="reg-confirm-password" class="neumo-inset w-full bg-transparent border-none rounded-2xl py-3.5 px-4" placeholder="Confirmar contraseña" required>
                <button type="submit" class="neumo-button w-full bg-accent text-white font-bold py-4 rounded-2xl shadow-accent">Registrarse</button>
                <div class="text-center text-sm text-gray-500 mt-4"><button type="button" onclick="switchAuthView('login')" class="text-gray-900 font-bold hover:underline">Volver al Login</button></div>
            </form>
            
             <form id="forgot-form" class="space-y-4 hidden auth-view">
                <button type="button" onclick="switchAuthView('login')" class="text-gray-500 flex items-center gap-1 mb-4 text-xs font-bold hover:text-accent"><i data-lucide="arrow-left" class="w-3 h-3"></i> ATRÁS</button>
                <h2 class="text-xl font-bold text-gray-800">Recuperar Acceso</h2>
                <input type="email" id="forgot-email" class="neumo-inset w-full bg-transparent border-none rounded-2xl py-3.5 px-4" placeholder="Tu correo registrado" required>
                <button type="submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-4 rounded-2xl shadow-lg">Enviar Correo</button>
            </form>
        </div>
    </div>

    <div id="dashboard-container" class="hidden relative min-h-screen pb-20">
        
        <div id="app-modal" class="fixed inset-0 z-[80] hidden items-center justify-center p-4">
            <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
            <div id="modal-card" class="neumo-card w-full max-w-md p-0 relative shadow-2xl transform transition-all scale-100 opacity-100 max-h-[90vh] flex flex-col overflow-hidden">
                <button onclick="closeModal()" class="neumo-button absolute top-4 right-4 text-gray-400 hover:text-rose-500 z-50 bg-bg-primary rounded-full p-2"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div id="modal-content" class="overflow-y-auto scrollbar-hide p-6 w-full h-full"></div>
            </div>
        </div>

        <header class="neumo-flat sticky top-0 z-40 border-b border-gray-200 px-5 py-3 flex items-center justify-between shadow-sm" style="background-color: rgba(240, 240, 240, 0.95);">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="neumo-button p-2.5 text-gray-600 hover:bg-gray-100"><i data-lucide="menu" class="w-5 h-5"></i></button>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gray-900 rounded-lg flex items-center justify-center text-white font-bold text-xs neumo-card">SE</div>
                    <div class="flex flex-col">
                        <h1 class="text-sm font-bold text-gray-700 tracking-tight leading-none">STREAM<span class="text-accent">EVO</span></h1>
                        <span id="header-role-badge" class="text-[8px] uppercase font-black tracking-widest text-gray-400 leading-none mt-0.5">Cliente</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-[10px] bg-success/10 text-success px-2.5 py-1 rounded-full font-bold flex items-center gap-1.5 border border-success/20 neumo-card neumo-flat"><div class="w-1.5 h-1.5 rounded-full bg-success animate-pulse"></div> ONLINE</div>
                <button onclick="openNotifications()" class="neumo-button p-2 text-gray-500 hover:text-accent transition-colors relative">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span id="notification-dot" class="absolute top-2 right-2 w-2 h-2 bg-danger rounded-full border border-bg-primary hidden animate-bounce"></span>
                </button>
            </div>
        </header>

        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-gray-900/20 backdrop-blur-sm z-50 opacity-0 pointer-events-none transition-opacity duration-300"></div>
        <aside id="sidebar" class="neumo-flat fixed top-0 left-0 h-full w-72 shadow-2xl z-50 transition-transform duration-300 -translate-x-full flex flex-col" style="border-right: 1px solid rgba(0,0,0,0.05);">
            <div class="p-6 border-b border-gray-100">
                <h2 class="font-bold text-lg text-gray-800">Mi Cuenta</h2>
                <p class="text-xs text-gray-400 truncate font-mono mt-1" id="sidebar-email">Cargando...</p>
                <div id="sidebar-role-tag" class="inline-block mt-2 bg-gray-100 text-gray-500 text-[10px] px-2 py-0.5 rounded font-bold uppercase neumo-card neumo-flat">Cliente</div>
            </div>
            <div class="p-4 space-y-2 overflow-y-auto flex-1 scrollbar-hide">
                <div id="user-menu-items">
                    <div onclick="switchView('user'); toggleSidebar();" class="neumo-button flex items-center gap-3 p-3.5 rounded-xl bg-accent/10 text-accent font-semibold cursor-pointer">
                        <i data-lucide="home" class="w-5 h-5"></i><span class="text-sm">Inicio</span>
                    </div>
                    <button onclick="openReportModal(); toggleSidebar();" class="neumo-button w-full flex items-center gap-3 p-3.5 rounded-xl text-gray-500 hover:text-gray-800">
                        <i data-lucide="life-buoy" class="w-5 h-5"></i><span class="text-sm font-medium">Reportar Fallo</span>
                    </button>
                    <button onclick="openSupportReplies(); toggleSidebar();" class="neumo-button w-full flex items-center gap-3 p-3.5 rounded-xl text-gray-500 hover:text-gray-800">
                        <i data-lucide="message-circle-question" class="w-5 h-5"></i>
                        <span class="text-sm font-medium">Respuestas Soporte</span>
                    </button>
                    <button onclick="openNotifications(); toggleSidebar();" class="neumo-button w-full flex items-center gap-3 p-3.5 rounded-xl text-gray-500 hover:text-gray-800">
                        <i data-lucide="clock" class="w-5 h-5"></i><span class="text-sm font-medium">Movimientos</span>
                    </button>
                    <button id="btn-invite-reseller" onclick="openInviteModal(); toggleSidebar();" class="neumo-button hidden w-full flex items-center gap-3 p-3.5 rounded-xl text-indigo-600 bg-indigo-50/50 hover:bg-indigo-100 transition-all">
                        <i data-lucide="users" class="w-5 h-5"></i><span class="text-sm font-bold">Invitar Amigos</span>
                    </button>
                    <button onclick="openRenewalModal(); toggleSidebar();" class="neumo-button w-full flex items-center gap-3 p-3.5 rounded-xl text-gray-500 hover:text-gray-800">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i><span class="text-sm font-medium">Renovar</span>
                    </button>
                </div>
                
                <div id="admin-menu-items" class="hidden">
                    <div onclick="switchView('admin'); returnToAdminDashboard(); toggleSidebar();" class="neumo-button flex items-center gap-3 p-3.5 rounded-xl bg-gray-800 text-white font-semibold cursor-pointer mb-4 shadow-lg">
                        <i data-lucide="layout-grid" class="w-5 h-5 text-accent"></i>
                        <span class="text-sm">Panel Admin</span>
                    </div>
                    <div onclick="switchView('user'); toggleSidebar();" class="neumo-button flex items-center gap-3 p-3.5 rounded-xl text-gray-600 font-medium cursor-pointer hover:bg-gray-100">
                        <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                        <span class="text-sm">Vista Tienda</span>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100">
                <button onclick="handleLogout()" class="neumo-button w-full flex items-center justify-center gap-2 p-3 rounded-xl text-rose-500 hover:bg-rose-50/10 font-bold transition-colors text-sm"><i data-lucide="log-out" class="w-4 h-4"></i> Cerrar Sesión</button>
            </div>
        </aside>

        <main id="user-view" class="px-5 py-6 space-y-8 max-w-md mx-auto md:max-w-4xl">
            <section class="flex justify-between items-center gap-4 overflow-x-auto pb-2 scrollbar-hide bounce-enter" style="animation-delay: 0.1s;">
                <div class="flex-1 min-w-[120px] p-5 flex flex-col items-center justify-center neumo-card" style="background: var(--color-text-dark); color: white;">
                    <span class="text-[10px] uppercase tracking-widest opacity-60 mb-1 font-medium">Tu Saldo</span>
                    <span id="balance-display" class="font-bold text-xl text-success tracking-tight">--</span>
                </div>
                <div onclick="openProfitTransferModal()" class="flex-1 min-w-[120px] p-5 flex flex-col items-center justify-center cursor-pointer neumo-card">
                    <span class="text-[10px] uppercase tracking-widest opacity-50 mb-1 font-medium">Ganancias</span>
                    <span id="profit-display" class="font-bold text-xl tracking-tight">--</span>
                </div>
                <button onclick="openChargeModal()" class="neumo-button flex-none w-[70px] bg-accent text-white rounded-full py-4 flex flex-col items-center justify-center shadow-accent recharge-btn" style="border-radius: 50%;">
                    <i data-lucide="plus" class="w-6 h-6 mb-1"></i>
                </button>
            </section>

            <section class="relative w-full h-44 rounded-[2rem] overflow-hidden shadow-lg group cursor-pointer neumo-card" style="animation-delay: 0.2s;">
                <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1593784991095-a205069470b6?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center transition-transform duration-700 group-hover:scale-110"></div>
                <div class="absolute inset-0 bg-gradient-to-r from-gray-900/90 via-gray-900/60 to-transparent flex items-center px-8">
                    <div class="z-10 max-w-[70%]">
                        <span class="bg-accent text-white px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider mb-3 inline-block shadow-sm">Destacado</span>
                        <h3 class="text-white font-black text-xl leading-tight mb-2">Entretenimiento Premium</h3>
                        <p class="text-gray-300 text-xs mb-4 font-medium">Las mejores plataformas al mejor precio.</p>
                    </div>
                </div>
            </section>

            <section class="bounce-enter" style="animation-delay: 0.3s;">
                <div class="flex items-center justify-between mb-5">
                    <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2"><i data-lucide="grid" class="w-4 h-4 text-accent"></i> Servicios</h3>
                </div>
                <div id="categories-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="col-span-2 text-center py-10 text-gray-400 animate-pulse text-xs">Cargando servicios...</div>
                </div>
            </section>
        </main>

        <main id="admin-view" class="hidden px-5 py-6 space-y-6 max-w-md mx-auto md:max-w-4xl bounce-enter">
            <div id="admin-dashboard-grid" class="space-y-6">
                <div class="p-8 rounded-[2rem] relative overflow-hidden neumo-card" style="background: var(--color-text-dark); color: white;">
                    <div class="absolute right-0 top-0 w-48 h-48 bg-accent rounded-full blur-3xl opacity-10 transform translate-x-10 -translate-y-10"></div>
                    <h2 class="text-2xl font-bold mb-1 relative z-10">Panel de Control</h2>
                    <p class="text-gray-400 text-sm relative z-10">Gestión integral del ecosistema</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div onclick="enterAdminModule('requests')" class="admin-card p-5 rounded-3xl flex flex-col items-center justify-center cursor-pointer h-40 relative overflow-hidden group neumo-card">
                        <div class="w-12 h-12 bg-accent/10 text-accent rounded-2xl flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><i data-lucide="dollar-sign" class="w-6 h-6"></i></div>
                        <span class="font-bold text-gray-700 text-sm">Pagos</span>
                        <div id="badge-requests" class="absolute top-4 right-4 bg-danger text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden shadow-sm">0</div>
                    </div>

                    <div onclick="enterAdminModule('renewal')" class="admin-card p-5 rounded-3xl flex flex-col items-center justify-center cursor-pointer h-40 relative overflow-hidden group neumo-card">
                        <div class="w-12 h-12 bg-indigo-50/50 text-indigo-500 rounded-2xl flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><i data-lucide="refresh-cw" class="w-6 h-6"></i></div>
                        <span class="font-bold text-gray-700 text-sm">Renovaciones</span>
                        <div id="badge-renewal" class="absolute top-4 right-4 bg-danger text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden shadow-sm">0</div>
                    </div>

                    <div onclick="enterAdminModule('support')" class="admin-card p-5 rounded-3xl flex flex-col items-center justify-center cursor-pointer h-40 relative overflow-hidden group neumo-card">
                        <div class="w-12 h-12 bg-blue-50/50 text-blue-500 rounded-2xl flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><i data-lucide="message-square" class="w-6 h-6"></i></div>
                        <span class="font-bold text-gray-700 text-sm">Soporte</span>
                        <div id="badge-support" class="absolute top-4 right-4 bg-danger text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden shadow-sm">0</div>
                    </div>

                    <div onclick="enterAdminModule('categories')" class="admin-card col-span-2 p-5 rounded-3xl shadow-lg flex items-center justify-between cursor-pointer group neumo-card">
                         <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-accent/10 text-accent rounded-2xl flex items-center justify-center backdrop-blur-sm"><i data-lucide="layers" class="w-6 h-6"></i></div>
                            <div class="text-left">
                                <span class="font-bold text-gray-700 text-lg block">Gestionar Servicios</span>
                                <span class="text-xs text-gray-500">Agregar o editar categorías (Botones)</span>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="text-gray-400 group-hover:translate-x-1 transition-transform"></i>
                    </div>

                    <div onclick="enterAdminModule('users')" class="admin-card p-5 rounded-3xl flex flex-col items-center justify-center cursor-pointer h-32 group neumo-card">
                        <div class="w-10 h-10 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center mb-2 group-hover:bg-gray-200 transition-colors"><i data-lucide="users" class="w-5 h-5"></i></div>
                        <span class="font-bold text-gray-700 text-xs">Usuarios</span>
                    </div>

                    <div onclick="enterAdminModule('inventory')" class="admin-card p-5 rounded-3xl flex flex-col items-center justify-center cursor-pointer h-32 group neumo-card">
                        <div class="w-10 h-10 bg-indigo-50/50 text-indigo-600 rounded-full flex items-center justify-center mb-2 hover:bg-indigo-100 transition-colors"><i data-lucide="archive" class="w-5 h-5"></i></div>
                        <span class="font-bold text-gray-700 text-xs">Cuentas</span>
                    </div>

                    <div onclick="enterAdminModule('stock')" class="admin-card p-5 rounded-3xl flex items-center justify-center cursor-pointer h-32 group col-span-2 neumo-card">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-success/10 text-success rounded-full flex items-center justify-center hover:bg-emerald-100 transition-colors"><i data-lucide="package" class="w-5 h-5"></i></div>
                            <div class="text-left">
                                <span class="font-bold text-gray-700 text-sm block">Productos (Vitrina)</span>
                                <span class="text-[10px] text-gray-400">Items visibles para el usuario</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="admin-modules-container" class="hidden">
                <button onclick="returnToAdminDashboard()" class="neumo-button mb-6 flex items-center gap-2 text-gray-500 hover:text-gray-800 font-bold text-xs uppercase tracking-wider transition-colors">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> VOLVER AL PANEL
                </button>

                <section id="admin-categories-section" class="hidden bounce-enter">
                    <div class="flex justify-between items-center mb-6">
                        <div><h3 class="font-bold text-gray-800 text-xl">Mis Servicios</h3><p class="text-xs text-gray-400">Categorías visibles</p></div>
                        <button onclick="openAddCategoryModal()" class="neumo-button bg-gray-900 text-white px-4 py-2.5 rounded-xl text-xs font-bold flex items-center gap-2 shadow-lg"><i data-lucide="plus" class="w-4 h-4"></i> Crear Nueva</button>
                    </div>
                    <div id="admin-categories-list" class="grid grid-cols-2 gap-4"><p class="col-span-2 text-center text-gray-400 py-10">Cargando servicios...</p></div>
                </section>

                <section id="admin-requests-section" class="hidden bounce-enter">
                    <h3 class="font-bold text-gray-800 mb-4 text-xl">Solicitudes de Saldo</h3>
                    <div id="admin-requests-list" class="space-y-3"></div>
                </section>
                
                <section id="admin-renewal-section" class="hidden bounce-enter">
                    <h3 class="font-bold text-gray-800 mb-4 text-xl">Solicitudes de Renovación</h3>
                    <div id="admin-renewal-list" class="space-y-3"></div>
                </section>

                <section id="admin-users-section" class="hidden bounce-enter">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-800 text-xl">Usuarios</h3>
                        <button onclick="openAddUserModal()" class="neumo-button bg-success text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-1 shadow-accent"><i data-lucide="user-plus" class="w-4 h-4"></i> Nuevo</button>
                    </div>
                    <div id="admin-users-list" class="space-y-3"></div>
                </section>

                <section id="admin-stock-section" class="hidden bounce-enter">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-800 text-xl">Productos</h3>
                        <button onclick="openAddProductModal()" class="neumo-button bg-gray-900 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-1 shadow-lg"><i data-lucide="plus" class="w-4 h-4"></i> Agregar</button>
                    </div>
                    <div id="admin-stock-list" class="space-y-3"></div>
                </section>

                <section id="admin-inventory-section" class="hidden bounce-enter">
                    <div class="flex justify-between items-center mb-4">
                        <div><h3 class="font-bold text-gray-800 text-xl">Inventario</h3><p class="text-xs text-gray-400">Cuentas a entregar</p></div>
                        <button onclick="openAddInventoryModal()" class="neumo-button bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-1 shadow-lg"><i data-lucide="archive" class="w-4 h-4"></i> Cargar Item</button>
                    </div>
                    <div id="admin-inventory-list" class="space-y-3"></div>
                </section>

                <section id="admin-support-section" class="hidden bounce-enter">
                    <h3 class="font-bold text-gray-800 text-xl mb-4">Mesa de Ayuda</h3>
                    <div id="admin-support-list" class="space-y-3"></div>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, query, orderBy, limit, serverTimestamp, setDoc, getDoc, runTransaction, updateDoc, deleteDoc, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- CONFIGURACIÓN ---
        const firebaseConfig = {
          apiKey: "AIzaSyBYaYm2LDE6QM_K5Dii74sfZCYYd1eQfvY",
          authDomain: "ventasstre-a24b7.firebaseapp.com",
          projectId: "ventasstre-a24b7",
          storageBucket: "ventasstre-a24b7.firebasestorage.app",
          messagingSenderId: "197117622028",
          appId: "1:197117622028:web:ae6380faf72f965a41fb29",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "mi-ecosistema-v1";
        const ADMIN_EMAIL = "mrandroidtutorialeshd@gmail.com";
        const REFERRAL_COMMISSION_RATE = 0.10;
                 // --- INICIO CONFIGURACIÓN JERARQUÍAS ---
        const ROLE_DEFINITIONS = {
            'lider': { label: 'Lider', icon: 'crown', color: 'text-amber-500', bg: 'bg-amber-100', rank: 4 },
            'reseller': { label: 'Revendedor', icon: 'briefcase', color: 'text-indigo-600', bg: 'bg-indigo-100', rank: 3 },
            'vip': { label: 'Cliente Vip', icon: 'star', color: 'text-purple-600', bg: 'bg-purple-100', rank: 2 },
            'client': { label: 'Cliente', icon: 'user', color: 'text-gray-500', bg: 'bg-gray-100', rank: 1 }
        };

        function getRoleData(role) {
            return ROLE_DEFINITIONS[role] || ROLE_DEFINITIONS['client'];
        }
        // --- FIN CONFIGURACIÓN JERARQUÍAS ---


        let currentUser = null;
        let isAdmin = false;
        let currentUserRole = 'client';
        let currentProfit = 0; 
        let timerInterval;

        window.userTransactions = [];
        window.globalNotifications = []; 
        window.adminPendingRequests = []; 
        window.adminPendingReports = [];
        window.adminReportsCache = []; 
        window.categoriesCache = []; 
        window.currentUserHistory = [];
        window.adminPendingRenewals = [];
        window.inventoryCache = [];

        // Audio
        const alertSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3");
        window.playNotificationSound = () => { try { alertSound.currentTime = 0; alertSound.play().catch(e=>{}); } catch(e){} };

        // --- AUTH OBSERVER ---
        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('global-loader');
            const authContainer = document.getElementById('auth-container');
            const dashboardContainer = document.getElementById('dashboard-container');
            
            if (user && !user.emailVerified) {
                await signOut(auth);
                currentUser = null;
                dashboardContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                loader.style.display = 'none';
                return;
            }

            if (user) {
                const userStatusRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', user.uid);
                const userStatusSnap = await getDoc(userStatusRef);
                
                if (userStatusSnap.exists()) {
                    const userData = userStatusSnap.data();
                    if (userData.suspended === true) {
                        await signOut(auth);
                        showToast('Cuenta suspendida por administración.', 'error');
                        return;
                    }
                    currentUserRole = userData.role || 'client';
                } else {
                    currentUserRole = 'client'; 
                }

                currentUser = user;
                isAdmin = user.email === ADMIN_EMAIL;
                document.getElementById('sidebar-email').textContent = user.email;
                
                                // --- INICIO NUEVA LÓGICA DE BADGES ---
                const roleData = getRoleData(currentUserRole);

                // Badge del Sidebar (Menú lateral)
                const sidebarBadge = document.getElementById('sidebar-role-tag');
                sidebarBadge.className = `inline-flex items-center gap-1 mt-2 text-[10px] px-2 py-0.5 rounded font-bold uppercase neumo-card neumo-flat ${roleData.bg} ${roleData.color}`;
                sidebarBadge.innerHTML = `<i data-lucide="${roleData.icon}" class="w-3 h-3"></i> ${roleData.label}`;
                
                // Badge del Header (Arriba a la derecha)
                const headerBadge = document.getElementById('header-role-badge');
                headerBadge.className = `text-[8px] uppercase font-black tracking-widest leading-none mt-0.5 flex items-center gap-1 ${roleData.color}`;
                headerBadge.innerHTML = `<i data-lucide="${roleData.icon}" class="w-3 h-3"></i> ${roleData.label}`;

                // Botón invitar (Solo visible si NO es cliente normal)
                const btnInvite = document.getElementById('btn-invite-reseller');
                if(currentUserRole !== 'client') btnInvite.classList.remove('hidden');
                else btnInvite.classList.add('hidden');
                // --- FIN NUEVA LÓGICA DE BADGES ---


                await initCategories();

                if (isAdmin) {
                    document.getElementById('user-menu-items').classList.add('hidden');
                    document.getElementById('admin-menu-items').classList.remove('hidden');
                    initAdminPanel();
                    switchView('admin'); 
                } else {
                    document.getElementById('user-menu-items').classList.remove('hidden');
                    document.getElementById('admin-menu-items').classList.add('hidden');
                    switchView('user');
                }

                await initUserData(user);
                initGlobalNotifications(); 
                
                authContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
            } else {
                currentUser = null;
                isAdmin = false;
                dashboardContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
                checkReferralParam();
            }
            
            setTimeout(() => {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 700);
            }, 1500);
        });

        // --- SISTEMA DE REFERIDOS ---
        function checkReferralParam() {
            const urlParams = new URLSearchParams(window.location.search);
            const refId = urlParams.get('ref');
            if(refId) {
                document.getElementById('referral-badge').classList.remove('hidden');
                switchAuthView('register');
            }
        }

        // --- CATEGORÍAS DINÁMICAS ---
                async function initCategories() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'categories')); 
            onSnapshot(q, (snapshot) => {
                window.categoriesCache = [];
                snapshot.forEach(doc => window.categoriesCache.push({ id: doc.id, ...doc.data() }));

                // --- LÓGICA DE ORDENAMIENTO ---
                window.categoriesCache.sort((a, b) => {
                    // Si una categoría no tiene número (porque es vieja), le ponemos 999 para que se vaya al final
                    const orderA = (a.order !== undefined && a.order !== null) ? Number(a.order) : 999;
                    const orderB = (b.order !== undefined && b.order !== null) ? Number(b.order) : 999;
                    
                    // Ordena de menor a mayor (1, 2, 3...)
                    return orderA - orderB;
                });
                // -----------------------------

                renderUserCategories();
                if(isAdmin) renderAdminCategories();
            });
        }

        function renderUserCategories() {
            const grid = document.getElementById('categories-grid');
            if (!grid) return;
            if (window.categoriesCache.length === 0) { grid.innerHTML = `<div class="col-span-full text-center text-gray-400 text-sm py-8">No hay servicios disponibles.</div>`; return; }
            let html = '';
            window.categoriesCache.forEach(cat => {
                const color = cat.color || 'slate';
                html += `<div onclick="openCategoryModule('${cat.slug || cat.id}', '${cat.name}')" class="neumo-card p-5 flex flex-col items-center justify-center cursor-pointer transition-all hover:scale-105 group h-36"><div class="w-14 h-14 rounded-2xl bg-${color}-100 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform duration-300 neumo-inset"><i data-lucide="${cat.icon || 'box'}" class="w-7 h-7 text-${color}-600"></i></div><span class="font-bold text-gray-600 text-xs text-center group-hover:text-gray-900 transition-colors uppercase tracking-wide">${cat.name}</span></div>`;
            });
            grid.innerHTML = html; lucide.createIcons();
        }

        function renderAdminCategories() {
            const list = document.getElementById('admin-categories-list');
            if(!list) return;
            let html = '';
            window.categoriesCache.forEach(cat => {
                html += `<div class="neumo-card p-4 flex flex-col gap-3 relative group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-${cat.color || 'slate'}-100 flex items-center justify-center text-${cat.color || 'slate'}-600 neumo-inset"><i data-lucide="${cat.icon || 'box'}" class="w-5 h-5"></i></div>
                        <div><p class="font-bold text-gray-700 text-sm">${cat.name}</p><p class="text-[10px] text-gray-400 font-mono">slug: ${cat.slug}</p></div>
                    </div>
                    <div class="absolute top-3 right-3 flex gap-2">
                        <button onclick="openEditCategoryModal('${cat.id}')" class="neumo-button p-1 text-blue-500 hover:text-accent"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button onclick="deleteCategory('${cat.id}')" class="neumo-button p-1 text-rose-500 hover:text-danger"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>`;
            });
            list.innerHTML = html; lucide.createIcons();
        }

        window.openAddCategoryModal = () => {
            openModal(`
            <div class="text-left bounce-enter">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Nuevo Servicio</h3>
                <form onsubmit="saveCategory(event)" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Nombre</label>
                            <input type="text" id="cat-name" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-accent uppercase mb-1">Orden (1, 2, 3...)</label>
                            <input type="number" id="cat-order" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm font-bold" placeholder="Ej: 1" required>
                        </div>
                    </div>
                    
                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Identificador (Slug)</label><input type="text" id="cat-slug" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required placeholder="ej: streaming"></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Icono (Lucide)</label><input type="text" id="cat-icon" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required placeholder="ej: tv"></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Color</label><select id="cat-color" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm"><option value="amber">Ámbar</option><option value="blue">Azul</option><option value="emerald">Esmeralda</option><option value="rose">Rosa</option><option value="purple">Púrpura</option><option value="indigo">Índigo</option><option value="slate">Gris</option></select></div>
                    
                    <button type="submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg mt-2">Crear Categoría</button>
                </form>
            </div>`);
        };
        
        window.openEditCategoryModal = (id) => {
            const cat = window.categoriesCache.find(c => c.id === id);
            if (!cat) return showToast('Categoría no encontrada', 'error');
            const colors = ['amber', 'blue', 'emerald', 'rose', 'purple', 'indigo', 'slate'];
            const colorOptions = colors.map(c => `<option value="${c}" ${c === cat.color ? 'selected' : ''}>${c.charAt(0).toUpperCase() + c.slice(1)}</option>`).join('');

            // Si la categoría es vieja y no tiene orden, mostramos el campo vacío
            const currentOrder = (cat.order !== undefined) ? cat.order : '';

            openModal(`
            <div class="text-left bounce-enter">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Editar Servicio</h3>
                <form onsubmit="updateCategory(event, '${id}')" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Nombre</label>
                            <input type="text" id="edit-cat-name" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" value="${cat.name}" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-accent uppercase mb-1">Orden</label>
                            <input type="number" id="edit-cat-order" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm font-bold" value="${currentOrder}" placeholder="Ej: 1" required>
                        </div>
                    </div>
                    
                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Identificador (Slug)</label><input type="text" id="edit-cat-slug" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" value="${cat.slug}" required></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Icono (Lucide)</label><input type="text" id="edit-cat-icon" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" value="${cat.icon}" required></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Color</label><select id="edit-cat-color" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm">${colorOptions}</select></div>
                    
                    <button type="submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg mt-2">Guardar Cambios</button>
                </form>
            </div>`);
        };

        window.updateCategory = async (e, id) => {
            e.preventDefault();
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', id), {
                    name: document.getElementById('edit-cat-name').value,
                    slug: document.getElementById('edit-cat-slug').value.toLowerCase().trim(),
                    icon: document.getElementById('edit-cat-icon').value,
                    color: document.getElementById('edit-cat-color').value,
                    // ACTUALIZAMOS EL NÚMERO EN LA BASE DE DATOS
                    order: Number(document.getElementById('edit-cat-order').value), 
                });
                showToast('Categoría actualizada', 'success');
                closeModal();
            } catch(err) { showToast('Error al actualizar', 'error'); }
        };

        window.saveCategory = async (e) => { 
            e.preventDefault(); 
            try { 
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'categories'), { 
                    name: document.getElementById('cat-name').value, 
                    slug: document.getElementById('cat-slug').value.toLowerCase().trim(), 
                    icon: document.getElementById('cat-icon').value, 
                    color: document.getElementById('cat-color').value,
                    // AQUÍ GUARDAMOS EL NÚMERO EN LA BASE DE DATOS
                    order: Number(document.getElementById('cat-order').value), 
                    createdAt: serverTimestamp() 
                }); 
                showToast('Categoría creada', 'success'); 
                closeModal(); 
            } catch(err) { showToast('Error', 'error'); } 
        };
        window.deleteCategory = async (id) => { if(confirm("¿Eliminar categoría?")) try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', id)); showToast('Eliminada', 'success'); } catch(err) { showToast('Error', 'error'); } };

        // --- DATOS USUARIO ---
        async function initUserData(user) {
            const walletRef = doc(db, 'artifacts', appId, 'users', user.uid, 'wallet', 'main');
            onSnapshot(walletRef, (doc) => { 
                if (doc.exists()) { 
                    const data = doc.data(); 
                    document.getElementById('balance-display').textContent = `$${(data.balance || 0).toLocaleString()}`; 
                    document.getElementById('profit-display').textContent = `$${(data.profit || 0).toLocaleString()}`; 
                    currentProfit = data.profit || 0; 
                } else {
                    setDoc(walletRef, { balance: 0, profit: 0 });
                    currentProfit = 0;
                }
            });
            const txRef = collection(db, 'artifacts', appId, 'users', user.uid, 'transactions');
            onSnapshot(query(txRef, orderBy('timestamp', 'desc'), limit(20)), (snapshot) => { window.userTransactions = []; snapshot.forEach((doc) => { window.userTransactions.push({id: doc.id, ...doc.data()}); }); updateNotificationDot(); });
        }

        function initGlobalNotifications() {
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'global_notifications'), orderBy('timestamp', 'desc'), limit(5)), (snapshot) => { window.globalNotifications = []; snapshot.forEach(doc => window.globalNotifications.push({id: doc.id, isGlobal:true, ...doc.data()})); updateNotificationDot(); });
        }
        function updateNotificationDot() { 
            const dot = document.getElementById('notification-dot'); 
            let hasAdmin = (window.adminPendingRequests?.length > 0) || (window.adminPendingReports?.length > 0) || (window.adminPendingRenewals?.length > 0); 
            if (window.userTransactions.length > 0 || window.globalNotifications.length > 0 || (isAdmin && hasAdmin)) dot.style.display = 'block'; 
            else dot.style.display = 'none'; 
        }
        
        // --- MODAL Y FUNCIÓN DE TRANSFERENCIA DE GANANCIAS ---
        window.openProfitTransferModal = () => {
            if (currentUserRole !== 'reseller') {
                return showToast('Esta función es solo para Revendedores.', 'info');
            }

            let modalContent;
            
            if (currentProfit > 0) {
                modalContent = `
                    <div class="text-center bounce-enter">
                        <div class="w-16 h-16 bg-indigo-100 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset"><i data-lucide="chevrons-up-down" class="w-8 h-8"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Transferir Ganancias</h3>
                        <p class="text-xs text-gray-400 mb-6">Mueve tus ganancias disponibles a tu Saldo para usarlos en compras.</p>
                        
                        <div class="neumo-card neumo-inset p-4 rounded-xl text-left mb-4">
                            <p class="text-[10px] font-bold text-indigo-600 uppercase">Ganancia Disponible:</p>
                            <p class="text-2xl font-black text-indigo-700">$${(currentProfit).toLocaleString()}</p>
                        </div>

                        <form onsubmit="transferProfitToBalance(event, ${currentProfit})" class="space-y-4">
                            <input type="number" id="transfer-amount" class="neumo-inset w-full bg-transparent border-none rounded-xl px-4 py-3 text-lg font-bold text-center" placeholder="Monto a transferir" min="1" max="${currentProfit}" required>
                            <button type="submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg">Transferir a Saldo</button>
                        </form>
                    </div>
                `;
            } else {
                modalContent = `
                    <div class="text-center bounce-enter">
                        <div class="w-16 h-16 bg-rose-100 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset"><i data-lucide="dollar-sign" class="w-8 h-8"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Sin Ganancias Disponibles</h3>
                        <div class="neumo-card neumo-inset p-4 rounded-xl text-left mb-4">
                            <p class="text-[10px] font-bold text-indigo-600 uppercase">Ganancia Disponible:</p>
                            <p class="text-2xl font-black text-indigo-700">$0</p>
                        </div>
                        <p class="text-sm text-gray-500 mb-6 px-4">Actualmente no tienes ganancias para transferir a tu saldo principal. ¡Sigue invitando amigos!</p>
                        <button onclick="closeModal()" class="neumo-button w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg">Entendido</button>
                    </div>
                `;
            }
            openModal(modalContent);
        };

        window.transferProfitToBalance = async (e, maxAmount) => {
            e.preventDefault();
            const amount = Number(document.getElementById('transfer-amount').value);
            
            if (amount <= 0 || amount > maxAmount) {
                return showToast('Monto inválido o excede la ganancia disponible.', 'error');
            }

            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'Procesando...';

            const wRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'wallet', 'main');

            try {
                await runTransaction(db, async (t) => {
                    const s = await t.get(wRef);
                    const currentBal = s.data().balance || 0;
                    const currentProf = s.data().profit || 0;

                    if (currentProf < amount) {
                        throw new Error("Saldo de ganancia insuficiente (Error de concurrencia).");
                    }
                    t.update(wRef, { profit: currentProf - amount });
                    t.update(wRef, { balance: currentBal + amount });
                    
                    const txRef = doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'));
                    t.set(txRef, { 
                        type: 'deposit', 
                        amount: amount, 
                        description: 'Transferencia de Ganancias a Saldo', 
                        timestamp: serverTimestamp() 
                    });
                });

                showToast(`¡Transferencia de $${amount} exitosa!`, 'success');
                closeModal();
            } catch (e) {
                showToast('Error en la transferencia: ' + (e.message || 'Inténtalo de nuevo.'), 'error');
                btn.disabled = false;
                btn.innerText = originalText;
            }
        };

        // --- ADMIN PANEL ---
        function initAdminPanel() {
            // Solicitudes de Saldo (ACTUALIZADO)
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'pending_recharges'), orderBy('timestamp', 'desc'), limit(50)), (snapshot) => {
                window.adminPendingRequests = []; 
                let html = '';
                snapshot.forEach(doc => { 
                    const d = doc.data(); 
                    if(d.status === 'pending') { 
                        d.id = doc.id;
                        window.adminPendingRequests.push(d); 
                        html += `
                        <div class="neumo-card p-4 flex flex-col md:flex-row justify-between items-center gap-3 slide-up" style="border-left: 4px solid var(--color-accent);">
                            <div class="flex-1">
                                <p class="font-bold text-gray-800 text-sm">${d.email}</p>
                                <span class="bg-accent/10 text-accent text-[10px] font-bold px-2 py-1 rounded-full neumo-flat">Pendiente</span>
                                <p class="text-[10px] text-gray-400 mt-1">Expira: ${d.expiresAt ? d.expiresAt.toDate().toLocaleTimeString() : 'N/A'}</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-lg text-success">$${d.amount.toLocaleString()}</span>
                                <div class="flex gap-2">
                                    <button onclick="event.stopPropagation(); window.approveRecharge('${doc.id}', '${d.uid}', ${d.amount}, '${d.userTxId}')" class="neumo-button bg-success text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-emerald-600 flex items-center gap-1 shadow-lg" title="Aprobar"><i data-lucide="check" class="w-4 h-4"></i></button>
                                    <button onclick="event.stopPropagation(); window.rejectRecharge('${doc.id}', '${d.uid}', '${d.userTxId}')" class="neumo-button bg-danger text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-red-600 flex items-center gap-1 shadow-lg" title="Rechazar"><i data-lucide="x" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        </div>`; 
                    } 
                });
                document.getElementById('admin-requests-list').innerHTML = html || '<div class="text-center py-4 text-gray-400">Sin solicitudes</div>';
                const badge = document.getElementById('badge-requests'); 
                if(window.adminPendingRequests.length>0){badge.textContent=window.adminPendingRequests.length; badge.classList.remove('hidden');} else badge.classList.add('hidden');
                lucide.createIcons();
            });
            
            // Solicitudes de Renovación
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), where('type', '==', 'renewal'), where('status', '!=', 'resolved'), orderBy('timestamp', 'desc')), (s) => {
                window.adminPendingRenewals = []; let html = '';
                s.forEach(doc => { 
                    const r = doc.data(); r.id = doc.id; 
                    if(r.status === 'unread' || r.status === 'processing') {
                         window.adminPendingRenewals.push(r);
                         html += `<div class="neumo-card p-4 rounded-xl shadow-sm mb-3"><div class="flex justify-between items-start"><p class="font-bold text-sm text-gray-700">${r.email}</p><span class="text-[10px] uppercase ${r.status==='unread'?'text-danger':'text-accent'} font-bold neumo-flat">${r.status === 'unread' ? 'Nuevo' : 'En Proceso'}</span></div><p class="text-xs text-gray-500 mt-1 whitespace-pre-wrap">${r.description.split('\n')[0]}</p><div class="flex gap-2 mt-3 pt-2 border-t border-gray-200">
                            <button onclick="approveRenewal('${doc.id}', '${r.uid}')" class="neumo-button flex-1 bg-success text-white px-3 py-2 rounded-lg text-xs font-bold">Aprobar</button>
                            <button onclick="rejectRenewal('${doc.id}')" class="neumo-button flex-1 bg-danger text-white px-3 py-2 rounded-lg text-xs font-bold">Rechazar</button>
                            <button onclick="viewRenewalDetail('${doc.id}')" class="neumo-button bg-gray-100 text-gray-600 px-3 py-2 rounded-lg text-xs font-bold"><i data-lucide="eye" class="w-4 h-4"></i></button>
                         </div></div>`;
                    }
                });
                document.getElementById('admin-renewal-list').innerHTML = html || '<div class="text-center py-4 text-gray-400">Sin solicitudes de renovación pendientes</div>';
                const badge = document.getElementById('badge-renewal'); 
                if(window.adminPendingRenewals.length>0){badge.textContent=window.adminPendingRenewals.length; badge.classList.remove('hidden');} else badge.classList.add('hidden');
                lucide.createIcons();
            });

            // Productos (Vitrina)
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'profiles'), (snapshot) => {
                const products = [];
                snapshot.forEach(doc => products.push({ id: doc.id, ...doc.data() }));

                const groupedProducts = products.reduce((acc, product) => {
                    const category = product.category || 'otros';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(product);
                    return acc;
                }, {});

                const customOrder = ['perfiles', 'cuentas', 'música', 'libros', 'licencias', 'game pass', 'otros'];
                const sortedCategories = Object.keys(groupedProducts).sort((a, b) => {
                    const indexA = customOrder.indexOf(a.toLowerCase());
                    const indexB = customOrder.indexOf(b.toLowerCase());
                    if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                    if (indexA !== -1) return -1;
                    if (indexB !== -1) return 1;
                    return a.localeCompare(b);
                });

                let html = '';
                if (products.length === 0) {
                     html = '<p class="text-center text-gray-400">Sin productos visibles.</p>';
                } else {
                    sortedCategories.forEach(category => {
                        const displayName = category.charAt(0).toUpperCase() + category.slice(1).replace('-', ' ');
                        html += `
                            <div class="mt-8 mb-4">
                                <h4 class="font-black text-lg text-gray-800 border-b border-gray-200 pb-1">${displayName}</h4>
                            </div>
                            <div class="space-y-3">
                        `;
                        groupedProducts[category].forEach(d => {
                            html += `<div class="neumo-card p-3 flex items-center gap-3 slide-up relative overflow-hidden">
                                <img src="${d.imageUrl}" class="w-12 h-12 rounded-lg object-cover bg-gray-100 neumo-inset flex-shrink-0">
                                
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <p class="font-bold text-sm text-gray-800 truncate pr-2">${d.name}</p>
                                    </div>
                                    
                                    <div class="flex flex-wrap gap-1 mt-1 mb-1">
                                        <span class="text-[9px] font-bold text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200 neumo-flat" title="Cliente">
                                            Cli: $${d.priceClient || 0}
                                        </span>
                                        <span class="text-[9px] font-bold text-purple-600 bg-purple-50 px-1.5 py-0.5 rounded border border-purple-100 neumo-flat" title="Vip">
                                            Vip: $${d.priceVip || 0}
                                        </span>
                                        <span class="text-[9px] font-bold text-indigo-600 bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-100 neumo-flat" title="Revendedor">
                                            Rev: $${d.priceReseller || 0}
                                        </span>
                                        <span class="text-[9px] font-bold text-amber-600 bg-amber-50 px-1.5 py-0.5 rounded border border-amber-100 neumo-flat" title="Lider">
                                            Lid: $${d.priceLeader || 0}
                                        </span>
                                    </div>

                                    <div class="flex justify-between items-end">
                                        <p class="text-[10px] text-gray-400 truncate max-w-[100px]">${d.category}</p>
                                        <div class="text-[10px]">Stock: <b class="${(d.stock||0) < 1 ? 'text-danger' : 'text-gray-800'}">${d.stock||0}</b></div>
                                    </div>
                                </div>

                                <div class="flex flex-col gap-1 pl-1 border-l border-gray-100">
                                    <button onclick="openEditProductModal('${d.id}')" class="neumo-button p-2 text-blue-500 hover:text-accent"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                    <button onclick="deleteProfile('${d.id}')" class="neumo-button p-2 text-rose-500 hover:text-danger"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>`;
                        });
                        html += `</div>`;
                    });
                }
                document.getElementById('admin-stock-list').innerHTML = html; lucide.createIcons();
            });
            // Usuarios 
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'all_users'), (snapshot) => {
                let html = ''; 
                snapshot.forEach(doc => { 
                    const d = doc.data(); 
                    const susp = d.suspended === true; 
                    const uRole = d.role || 'client';
                    const roleBadgeColor = uRole === 'reseller' ? 'bg-indigo-100 text-indigo-600' : 'bg-gray-100 text-gray-500';
                    html += `<div onclick="openUserHistory('${d.uid}', '${d.email}')" class="neumo-card p-3 flex flex-col gap-3 relative cursor-pointer hover:scale-105 transition-transform group slide-up">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 font-bold text-xs neumo-inset">${d.email.substring(0,2).toUpperCase()}</div>
                            <div class="overflow-hidden flex-1">
                                <p class="font-bold text-sm text-gray-700 truncate">${d.email}</p>
                                <div class="flex items-center gap-2">
                                    <p class="text-[10px] text-gray-400 font-mono">ID: ${d.uid.substring(0,8)}</p>
                                    <span class="text-[8px] font-bold uppercase px-1.5 py-0.5 rounded neumo-flat ${roleBadgeColor}">${uRole}</span>
                                </div>
                            </div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                        </div>
                        <div class="flex gap-2 pt-2 border-t border-gray-200" onclick="event.stopPropagation();">
                            <button onclick="openManualBalanceModal('${d.uid}', '${d.email}')" class="neumo-button flex-1 bg-success/10 text-success py-1.5 rounded-lg text-xs font-bold flex items-center justify-center gap-1"><i data-lucide="dollar-sign" class="w-3 h-3"></i> Cargar</button>
                            <button onclick="event.stopPropagation(); openChangeRoleModal('${doc.id}', '${uRole}', '${d.email}')" class="neumo-button px-3 bg-indigo-50/50 text-indigo-600 rounded-lg text-xs font-bold" title="Cambiar Rol"><i data-lucide="user-cog" class="w-3 h-3"></i></button>

                            <button onclick="toggleSuspend('${doc.id}', ${!susp})" class="neumo-button px-3 bg-gray-100 text-gray-500 rounded-lg text-xs font-bold">${susp?'Activar':'Suspender'}</button>
                        </div>
                    </div>`; 
                });
                document.getElementById('admin-users-list').innerHTML = html; lucide.createIcons();
            });
            // Inventario
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'inventory_items'), where('status', '==', 'available')), (snapshot) => {
                 let html = ''; 
                 window.inventoryCache = [];
                 snapshot.forEach(doc => { 
                    const i = doc.data(); 
                    i.id = doc.id;
                    window.inventoryCache.push(i);

                    // Determinar qué mostrar en el listado según el tipo
                    let detailInfo = '';
                    if (i.link) {
                        detailInfo = `<p class="text-xs text-indigo-500 mt-1 truncate">Libro: ${i.link}</p>`;
                    } else {
                        detailInfo = `<p class="text-xs text-gray-500 mt-1">Expira: ${i.expiryDate || 'N/A'}</p>`;
                    }

                    html += `<div class="neumo-card p-3 flex flex-col gap-2 slide-up">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-gray-800 text-sm">${i.serviceName}</p>
                                ${detailInfo}
                            </div>
                            <div class="flex gap-1">
                                <button onclick="openEditInventoryModal('${doc.id}')" class="neumo-button text-blue-500 hover:text-accent p-1.5 rounded-lg"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                <button onclick="deleteInventoryItem('${doc.id}')" class="neumo-button text-rose-500 hover:text-danger p-1.5 rounded-lg"><i data-lucide="trash" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>`; 
                });
                 document.getElementById('admin-inventory-list').innerHTML = html || '<p class="text-center text-gray-400">Inventario vacío</p>'; lucide.createIcons();
            });
            // Soporte
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), where('type', '!=', 'renewal'), orderBy('timestamp', 'desc')), (s) => {
                 window.adminPendingReports = []; window.adminReportsCache = []; let html = '';
                 s.forEach(doc => { const r = doc.data(); r.id = doc.id; window.adminReportsCache.push(r); if(r.status!=='replied') window.adminPendingReports.push(r);
                     html += `<div onclick="openReportDetails('${doc.id}')" class="neumo-card p-4 shadow-sm cursor-pointer mb-2"><div class="flex justify-between"><p class="font-bold text-xs text-gray-700">${r.email}</p><span class="text-[10px] uppercase ${r.status==='replied'?'text-success':'text-accent'} font-bold neumo-flat">${r.status}</span></div><p class="text-xs text-gray-500 mt-1 truncate">${r.description}</p><div class="mt-2 pt-2 border-t border-gray-200 flex justify-end"><button onclick="event.stopPropagation(); openReplyModal('${doc.id}', '${r.uid}')" class="neumo-button text-xs text-blue-500 font-bold hover:text-accent">Responder</button></div></div>`;
                 });
                 document.getElementById('admin-support-list').innerHTML = html || '<p class="text-center text-gray-400">Sin reportes</p>';
                 const b = document.getElementById('badge-support'); if(window.adminPendingReports.length>0){b.textContent=window.adminPendingReports.length; b.classList.remove('hidden');} else b.classList.add('hidden');
            });
        }

        // --- FUNCIONES DE INVENTARIO MEJORADAS (NUEVA LÓGICA) ---

        // Función para abrir el modal de Agregar Inventario (Modificada)
        window.openAddInventoryModal = async () => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'profiles')); 
            const querySnapshot = await getDocs(q);
            let options = '<option value="" data-category="">Selecciona un Artículo...</option>';
            
            querySnapshot.forEach((doc) => { 
                const data = doc.data(); 
                // Guardamos la categoría en un atributo data para usarlo en el JS
                options += `<option value="${doc.id}" data-category="${data.category || 'otros'}" data-name="${data.name}">${data.name}</option>`; 
            });

            openModal(`
                <div class="text-left bounce-enter">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Agregar al Inventario</h3>
                    <form onsubmit="saveInventoryItem(event)" class="space-y-3">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase">Artículo</label>
                            <select id="inv-product-select" onchange="toggleInventoryFields()" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm" required>
                                ${options}
                            </select>
                        </div>

                        <div id="fields-credentials">
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="block text-[10px] font-bold text-gray-400 uppercase">Correo</label><input type="email" id="inv-email" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm"></div>
                                <div><label class="block text-[10px] font-bold text-gray-400 uppercase">Contraseña</label><input type="text" id="inv-pass" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm"></div>
                            </div>
                        </div>

                        <div id="fields-profile-extra" class="hidden grid-cols-2 gap-2 mt-2">
                             <div><label class="block text-[10px] font-bold text-gray-400 uppercase">Nombre Perfil</label><input type="text" id="inv-profile-name" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm"></div>
                             <div><label class="block text-[10px] font-bold text-gray-400 uppercase">PIN</label><input type="text" id="inv-pin" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm"></div>
                        </div>

                        <div id="fields-book" class="hidden mt-2">
                           <label class="block text-[10px] font-bold text-gray-400 uppercase">Link Libro/Documento</label>

                           <input type="url" id="inv-link" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm" placeholder="https://...">
                        </div>

                        <div id="fields-dates" class="grid grid-cols-2 gap-2 mt-2">
                            <div><label class="block text-[10px] font-bold text-gray-400 uppercase">Expiración</label><input type="date" id="inv-expiry" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm"></div>
                            <div><label class="block text-[10px] font-bold text-gray-400 uppercase">Duración</label><select id="inv-duration" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm"><option>1 Mes</option><option>3 Meses</option><option>6 Meses</option><option>1 Año</option><option>Permanente</option></select></div>
                        </div>

                        <div class="mt-2"><label class="block text-[10px] font-bold text-gray-400 uppercase">Términos</label><textarea id="inv-terms" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm h-16 resize-none"></textarea></div>
                        <button type="submit" class="neumo-button w-full bg-indigo-600 text-white font-bold py-3 rounded-xl mt-2 hover:bg-indigo-700">Guardar</button>
                    </form>
                </div>
            `);
        };

        // Función para mostrar/ocultar campos según categoría
                // Función para mostrar/ocultar campos según categoría
                // --- CÓDIGO NUEVO PARA VISUALIZACIÓN DE CAMPOS ---
        window.toggleInventoryFields = () => {
            const select = document.getElementById('inv-product-select');
            const selectedOption = select.options[select.selectedIndex];
            
            // Si no hay opción seleccionada, salir
            if (!selectedOption) return;

            const category = selectedOption.getAttribute('data-category');

            const fieldsCreds = document.getElementById('fields-credentials');
            const fieldsProfile = document.getElementById('fields-profile-extra');
            const fieldsBook = document.getElementById('fields-book');
            const fieldsDates = document.getElementById('fields-dates');
            const emailInputContainer = document.getElementById('inv-email').parentNode;
            
            // 1. Resetear todo a estado "normal" (Streaming)
            fieldsCreds.classList.remove('hidden');
            emailInputContainer.classList.remove('hidden'); // Mostrar Email por defecto
            fieldsProfile.classList.add('hidden');
            fieldsProfile.classList.remove('grid'); // Quitar grid si estaba
            fieldsBook.classList.add('hidden');     // Ocultar Link
            fieldsDates.classList.remove('hidden'); // Mostrar Fechas

            // 2. Aplicar lógica según categoría
            if (category === 'libros' || category === 'documentos' || category === 'herramientas') {
                // CASO LINK (Libros, Herramientas, Documentos)
                emailInputContainer.classList.add('hidden'); // Ocultar Email
                fieldsBook.classList.remove('hidden');       // Mostrar Link
                fieldsDates.classList.add('hidden');         // Ocultar Fechas (Expiración)

            } else if (category === 'perfiles' || category === 'cuentas') {
                // CASO CUENTAS (Netflix, Disney, etc)
                fieldsProfile.classList.remove('hidden');
                fieldsProfile.classList.add('grid');
            }
            // Si es 'otros' o cualquier otra cosa, se queda con la config por defecto (Email + Pass + Fechas)
        };



        // Función Guardar Item Modificada
                // Función Guardar Item Modificada
                // --- CÓDIGO NUEVO PARA GUARDAR ITEM ---
        window.saveInventoryItem = async (e) => { 
            e.preventDefault(); 
            try { 
                const select = document.getElementById('inv-product-select'); 
                const productId = select.value; 
                const productName = select.options[select.selectedIndex].text; 
                const category = select.options[select.selectedIndex].getAttribute('data-category');

                let itemData = {
                    productId, 
                    serviceName: productName,
                    category: category,
                    terms: document.getElementById('inv-terms').value, 
                    createdAt: serverTimestamp(), 
                    status: 'available'
                };

                // VERIFICAMOS SI ES TIPO "LINK" (Herramientas, Libros...)
                if (category === 'libros' || category === 'documentos' || category === 'herramientas') {
                    itemData.link = document.getElementById('inv-link').value;
                    itemData.password = document.getElementById('inv-pass').value; 
                    
                    if(!itemData.link) return showToast('El Link es obligatorio', 'error');
                    // Aquí NO pedimos email ni fechas
                } else {
                    // TIPO "CUENTA" (Streaming, etc)
                    itemData.email = document.getElementById('inv-email').value;
                    itemData.password = document.getElementById('inv-pass').value;
                    itemData.expiryDate = document.getElementById('inv-expiry').value;
                    itemData.duration = document.getElementById('inv-duration').value;
                    
                    if (category === 'perfiles' || category === 'cuentas') {
                        itemData.profileName = document.getElementById('inv-profile-name').value;
                        itemData.pin = document.getElementById('inv-pin').value;
                    }
                    
                    if(!itemData.email || !itemData.password) return showToast('Correo y contraseña requeridos', 'error');
                }

                // Guardar en Inventario
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'inventory_items'), itemData); 
                
                // Sumar 1 al stock visual (Opcional, ya que será infinito, pero sirve para saber que hay items)
                const productRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', productId); 
                await updateDoc(productRef, { stock: increment(1) }); 
                
                showToast('Item agregado correctamente', 'success'); 
                closeModal(); 
            } catch(e) { 
                console.error(e);
                showToast('Error al guardar item: ' + e.message, 'error'); 
            } 
        };



        window.deleteInventoryItem = async (id) => { 
            if(confirm("¿Borrar? Reducirá el stock.")) { 
                const itemRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory_items', id); 
                const s = await getDoc(itemRef); 
                if (s.exists()) { 
                    await deleteDoc(itemRef); 
                    if (s.data().status === 'available') {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', s.data().productId), { stock: increment(-1) }); 
                    }
                    showToast('Eliminado', 'success'); 
                } 
            } 
        };

        window.openEditInventoryModal = (id) => {
            // Nota: Esta función es básica, si se requiere editar campos específicos (como PIN) habría que expandirla similar a saveInventoryItem
            const item = window.inventoryCache.find(i => i.id === id);
            if (!item) return showToast('Item no encontrado', 'error');

            const durations = ["1 Mes", "3 Meses", "6 Meses"];
            const durationOptions = durations.map(d => `<option value="${d}" ${d === item.duration ? 'selected' : ''}>${d}</option>`).join('');

            openModal(`
                <div class="text-left bounce-enter"><h3 class="text-lg font-bold text-gray-800 mb-4">Editar Item</h3>
                <form onsubmit="updateInventoryItem(event, '${id}')" class="space-y-3">
                    <div class="neumo-card neumo-inset p-2 rounded-lg"><label class="block text-[10px] font-bold text-gray-400 uppercase">Artículo</label><p class="font-bold text-sm text-gray-700">${item.serviceName}</p></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="block text-[10px] font-bold text-gray-400 uppercase">Correo / Link</label><input type="text" id="e-inv-email" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm" value="${item.email || item.link || ''}" required></div>
                        <div><label class="block text-[10px] font-bold text-gray-400 uppercase">Contraseña</label><input type="text" id="e-inv-pass" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm" value="${item.password || ''}" required></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="block text-[10px] font-bold text-gray-400 uppercase">Expiración</label><input type="date" id="e-inv-expiry" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm" value="${item.expiryDate || ''}"></div>
                        <div><label class="block text-[10px] font-bold text-gray-400 uppercase">Duración</label><select id="e-inv-duration" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm">${durationOptions}</select></div>
                    </div>
                    <div><label class="block text-[10px] font-bold text-gray-400 uppercase">Términos</label><textarea id="e-inv-terms" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm h-16 resize-none">${item.terms || ''}</textarea></div>
                    <button type="submit" class="neumo-button w-full bg-indigo-600 text-white font-bold py-3 rounded-xl mt-2 hover:bg-indigo-700">Guardar Cambios</button>
                </form></div>
            `);
        };

        window.updateInventoryItem = async (e, id) => {
            e.preventDefault();
            try {
                // Detectar si es link o email basado en el contenido básico
                const val = document.getElementById('e-inv-email').value;
                const isLink = val.includes('http');
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory_items', id), {
                    email: !isLink ? val : null,
                    link: isLink ? val : null,
                    password: document.getElementById('e-inv-pass').value,
                    expiryDate: document.getElementById('e-inv-expiry').value,
                    duration: document.getElementById('e-inv-duration').value,
                    terms: document.getElementById('e-inv-terms').value,
                });
                showToast('Item actualizado', 'success');
                closeModal();
            } catch(e) {
                showToast('Error al actualizar item', 'error');
            }
        };

        // --- FUNCIONES DE RENOVACIÓN DE ADMIN ---
        window.viewRenewalDetail = (id) => {
            const r = window.adminPendingRenewals.find(x => x.id === id) || window.adminReportsCache.find(x => x.id === id);
            if(!r) return showToast('Solicitud no encontrada', 'error');
            
            openModal(`
                <div class="text-left bounce-enter"><h3 class="font-bold text-gray-800 text-lg">Detalle de Renovación</h3>
                <p class="text-xs text-gray-500 mb-4">${r.email}</p>
                <div class="neumo-card neumo-inset p-4 rounded-xl text-sm space-y-2">
                    <p class="font-bold text-gray-700">Descripción:</p>
                    <p class="text-xs text-gray-600 whitespace-pre-wrap">${r.description}</p>
                    ${r.evidenceImage ? `<p class="mt-3 text-xs font-bold text-gray-400">Evidencia:</p><img src="${r.evidenceImage}" class="mt-1 w-full rounded-lg border border-gray-200">` : ''}
                </div>
                <div class="flex gap-2 mt-4">
                    <button onclick="approveRenewal('${r.id}', '${r.uid}')" class="neumo-button flex-1 bg-success text-white py-2 rounded-lg font-bold">Aprobar</button>
                    <button onclick="rejectRenewal('${r.id}')" class="neumo-button flex-1 bg-danger text-white py-2 rounded-lg font-bold">Rechazar</button>
                </div></div>
            `);
        };

        window.approveRenewal = async (id, uid) => {
            if(!confirm("¿Confirmar renovación?")) return;
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', id), { 
                    status: 'resolved', 
                    adminReply: 'Renovación APROBADA.',
                    resolvedAt: serverTimestamp() 
                });
                await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'transactions'), { 
                    type: 'support_reply', 
                    amount: 0, 
                    description: 'Renovación Aprobada', 
                    message: 'Su solicitud de renovación ha sido **APROBADA**.', 
                    timestamp: serverTimestamp() 
                });
                showToast('Renovación aprobada', 'success');
                closeModal();
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        };

        window.rejectRenewal = async (id) => {
            if(!confirm("¿Rechazar solicitud?")) return;
            try {
                const r = window.adminPendingRenewals.find(x => x.id === id);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', id), { 
                    status: 'rejected', 
                    adminReply: 'Renovación RECHAZADA.',
                    rejectedAt: serverTimestamp() 
                });
                 await addDoc(collection(db, 'artifacts', appId, 'users', r.uid, 'transactions'), { 
                    type: 'support_reply', 
                    amount: 0, 
                    description: 'Renovación Rechazada', 
                    message: 'Su solicitud de renovación ha sido **RECHAZADA**.', 
                    timestamp: serverTimestamp() 
                });
                showToast('Renovación rechazada', 'info');
                closeModal();
            } catch (e) {
                showToast('Error', 'error');
            }
        };

        // Soporte
        window.openReportModal = () => { localStorage.removeItem('report_evidence'); openModal(`<div class="text-left bounce-enter"><div class="w-14 h-14 bg-rose-100 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset"><i data-lucide="alert-triangle" class="w-7 h-7"></i></div><h3 class="text-xl font-bold text-gray-800 mb-2 text-center">Reportar Problema</h3><form onsubmit="submitReport(event)" class="space-y-4"><div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Tipo</label><select id="report-type" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm"><option value="account">Fallo de Cuenta</option><option value="payment">Pago no reflejado</option><option value="bug">Error de Sistema</option></select></div><div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Descripción</label><textarea id="report-desc" required class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm h-24 resize-none"></textarea></div><div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Adjuntar Foto</label><input type="file" accept="image/*" onchange="handleImageUpload(this)" class="w-full text-xs"></div><button type="submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-3 rounded-xl">Enviar Reporte</button></form></div>`); };
        window.handleImageUpload = (input) => { if (input.files[0]) { const reader = new FileReader(); reader.onload = (e) => localStorage.setItem('report_evidence', e.target.result); reader.readAsDataURL(input.files[0]); } };
        window.submitReport = async (e) => { e.preventDefault(); const type = document.getElementById('report-type').value; const evidence = localStorage.getItem('report_evidence'); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), { uid: currentUser.uid, email: currentUser.email, type, description: document.getElementById('report-desc').value, evidenceImage: evidence, timestamp: serverTimestamp(), status: 'unread' }); showToast('Reporte enviado', 'success'); closeModal(); };
        window.openReportDetails = (id) => { const r = window.adminReportsCache.find(x => x.id === id); if(!r) return; openModal(`<div class="text-left bounce-enter"><h3 class="font-bold text-gray-800 text-lg">Detalle Reporte</h3><p class="text-xs text-gray-500 mb-4">${r.email}</p><div class="neumo-card neumo-inset p-3 text-sm whitespace-pre-wrap">${r.description}</div>${r.evidenceImage ? `<img src="${r.evidenceImage}" class="mt-4 w-full rounded-lg border border-gray-200">` : ''}<div class="flex gap-2 mt-4"><button onclick="openReplyModal('${id}', '${r.uid}')" class="neumo-button flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">Responder</button><button onclick="closeModal()" class="neumo-button flex-1 bg-gray-200 py-2 rounded-lg font-bold">Cerrar</button></div></div>`); };
        window.openReplyModal = (rid, uid) => { openModal(`<div class="bounce-enter"><h3 class="font-bold mb-2">Responder</h3><textarea id="rep-text" class="neumo-inset w-full border rounded-xl p-2 h-24"></textarea><button onclick="sendAdminReply('${rid}','${uid}')" class="neumo-button w-full bg-blue-600 text-white font-bold py-2 rounded-xl mt-2">Enviar</button></div>`); };
        window.sendAdminReply = async (rid, uid) => { const msg = document.getElementById('rep-text').value; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', rid), { status: 'replied', adminReply: msg }); await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'transactions'), { type: 'support_reply', amount: 0, description: 'Respuesta Soporte', message: msg, timestamp: serverTimestamp() }); showToast('Enviado', 'success'); closeModal(); };

        // Gestión Usuarios
        window.openAddUserModal = () => { openModal(` <div class="text-left bounce-enter"><h3 class="text-xl font-bold text-gray-800 mb-4">Agregar Usuario</h3><form onsubmit="registerUserByAdmin(event)" class="space-y-4"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Correo</label><input type="email" id="new-user-email" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Contraseña</label><input type="text" id="new-user-pass" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required minlength="6"></div><button type="submit" class="neumo-button w-full bg-success text-white font-bold py-3 rounded-xl shadow-lg mt-2">Crear</button></form></div> `); };
        
        window.registerUserByAdmin = async (e) => { e.preventDefault(); const email = document.getElementById('new-user-email').value; const password = document.getElementById('new-user-pass').value; try { const secondaryApp = initializeApp(firebaseConfig, "SecondaryApp"); const secondaryAuth = getAuth(secondaryApp); const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password); await setDoc(doc(db, 'artifacts', appId, 'users', cred.user.uid, 'wallet', 'main'), { balance: 0, profit: 0, createdAt: serverTimestamp() }); await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', cred.user.uid), { email: email, uid: cred.user.uid, role: 'client', lastLogin: serverTimestamp(), suspended: false }, { merge: true }); await signOut(secondaryAuth); showToast('Usuario creado (Cliente)', 'success'); closeModal(); } catch (error) { showToast('Error: ' + error.message, 'error'); } };
        window.openManualBalanceModal = (uid, email) => { openModal(`<div class="text-center bounce-enter"><h3 class="text-xl font-bold text-gray-800 mb-1">Cargar Saldo Manual</h3><p class="text-xs text-gray-400 mb-4">${email}</p><input type="number" id="manual-amount" class="neumo-inset w-full bg-transparent border-none rounded-xl px-4 py-3 text-lg font-bold text-center mb-4" placeholder="$0"><button onclick="confirmManualBalance('${uid}')" class="neumo-button w-full bg-success text-white font-bold py-3 rounded-xl shadow-lg">Confirmar Recarga</button></div>`); };
        window.confirmManualBalance = async (uid) => { const amt = Number(document.getElementById('manual-amount').value); if(!amt) return; const wRef = doc(db, 'artifacts', appId, 'users', uid, 'wallet', 'main'); await runTransaction(db, async (t) => { const s = await t.get(wRef); t.update(wRef, { balance: (s.data().balance||0) + amt }); const txRef = doc(collection(db, 'artifacts', appId, 'users', uid, 'transactions')); t.set(txRef, { type: 'deposit', amount: amt, description: 'Carga Manual Admin', timestamp: serverTimestamp(), prevBalance: s.data().balance, newBalance: (s.data().balance||0) + amt }); }); showToast('Saldo cargado', 'success'); closeModal(); };
                        // --- REEMPLAZA LA FUNCIÓN toggleUserRole POR ESTAS DOS: ---

        // 1. Abrir modal con selector
        window.openChangeRoleModal = (docId, currentRole, email) => {
            // Generamos las opciones basándonos en tu configuración de roles existente
            let optionsHTML = '';
            for (const [key, val] of Object.entries(ROLE_DEFINITIONS)) {
                const selected = key === currentRole ? 'selected' : '';
                optionsHTML += `<option value="${key}" ${selected}>${val.label}</option>`;
            }

            openModal(`
                <div class="text-left bounce-enter">
                    <h3 class="text-xl font-bold text-gray-800 mb-1">Cambiar Rol</h3>
                    <p class="text-xs text-gray-400 mb-4">Usuario: ${email}</p>
                    
                    <form onsubmit="saveUserRole(event, '${docId}')">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Selecciona el nuevo rol</label>
                        <div class="neumo-inset p-1 rounded-xl mb-6">
                            <select id="role-selector" class="w-full bg-transparent border-none rounded-xl p-3 text-sm font-bold text-gray-700 focus:ring-0">
                                ${optionsHTML}
                            </select>
                        </div>
                        
                        <button type="submit" class="neumo-button w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition-all">
                            Guardar Cambio
                        </button>
                    </form>
                </div>
            `);
        };

        // 2. Guardar el cambio
        window.saveUserRole = async (e, docId) => {
            e.preventDefault();
            const newRole = document.getElementById('role-selector').value;
            const roleLabel = ROLE_DEFINITIONS[newRole].label;
            
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', docId), { role: newRole });
                showToast(`Rol actualizado a ${roleLabel}`, 'success');
                closeModal();
            } catch(error) {
                console.error(error);
                showToast('Error al actualizar el rol', 'error');
            }
        };


        window.toggleSuspend = async (uid, val) => { await updateDoc(doc(db,'artifacts',appId,'public','data','all_users',uid), {suspended: val}); };
                window.openUserHistory = async (uid, email) => { 
            const walletSnap = await getDoc(doc(db, 'artifacts', appId, 'users', uid, 'wallet', 'main')); 
            const balance = walletSnap.exists() ? walletSnap.data().balance : 0; 
            
            // Renderizar el modal principal del historial
            openModal(`
                <div class="h-[80vh] flex flex-col bounce-enter">
                    <div class="border-b border-gray-100 pb-4 mb-4">
                        <h3 class="font-bold text-xl text-gray-800 mb-1">Expediente de Usuario</h3>
                        <p class="text-sm text-gray-500 font-medium mb-4 flex flex-col gap-1"><span>${email}</span></p>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="neumo-card neumo-inset p-3">
                                <p class="text-[10px] font-bold text-success uppercase tracking-wider">Saldo Actual</p>
                                <p class="text-lg font-black text-success">$${balance.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto scrollbar-hide space-y-2" id="usr-hist-list">
                        <div class="text-center py-10"><div class="animate-spin w-6 h-6 border-2 border-gray-800 border-t-transparent rounded-full mx-auto"></div></div>
                    </div>
                </div>
            `); 
            
            const q = query(collection(db,'artifacts',appId,'users',uid,'transactions'), orderBy('timestamp','desc')); 
            const s = await getDocs(q); 
            let h=''; 
            
            if(s.empty) {
                h='<div class="text-center text-gray-400 py-10 text-xs">Sin movimientos.</div>'; 
            } else { 
                s.forEach(d=>{ 
                    const t=d.data(); 
                    // AQUI ESTA EL CAMBIO: Se agrega onclick, cursor pointer y efectos hover
                    h+=`
                    <div onclick="openUserTransactionDetail('${d.id}', '${uid}', '${email}')" class="neumo-card p-3 text-xs cursor-pointer hover:scale-[0.99] transition-transform relative group">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-gray-700 truncate pr-4">${t.description}</p>
                            <span class="text-[10px] text-gray-400 whitespace-nowrap">${t.timestamp?.toDate().toLocaleDateString()}</span>
                        </div>
                        <p class="font-bold ${t.type==='deposit'?'text-success':'text-danger'} mt-1">
                            ${t.amount > 0 ? '$'+t.amount.toLocaleString() : (t.amount < 0 ? '-$'+Math.abs(t.amount).toLocaleString() : 'Info')}
                        </p>
                        <div class="absolute right-3 bottom-3 opacity-0 group-hover:opacity-100 transition-opacity">
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                        </div>
                    </div>`;
                }); 
            } 
            document.getElementById('usr-hist-list').innerHTML=h; 
            lucide.createIcons();
        };
        window.openUserTransactionDetail = async (txId, uid, email) => {
            // Obtener datos frescos de la transacción
            const txDoc = await getDoc(doc(db, 'artifacts', appId, 'users', uid, 'transactions', txId));
            if (!txDoc.exists()) return showToast('Transacción no encontrada', 'error');
            const t = txDoc.data();
            
            let modalContent = '';

            // --- DISEÑO PARA RECARGAS (DEPOSIT) ---
            if (t.type === 'deposit') {
                let statusColor = 'text-success'; let statusText = 'Éxito';
                if(t.status==='Pending'||t.status==='pending'||t.status==='Pendiente'){ statusColor = 'text-accent'; statusText = 'Pendiente'; } 
                else if (['rejected','cancelled','Rechazado','Cancelado'].includes(t.status)) { statusColor = 'text-danger'; statusText = 'Cancelado'; }
                
                modalContent = `
                <div class="text-center bounce-enter pt-4">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset"><i data-lucide="dollar-sign" class="w-8 h-8 text-gray-500"></i></div>
                    <h3 class="text-xl font-bold text-gray-800 mb-1">Detalle de Recarga</h3>
                    <p class="text-xs text-gray-400 mb-6">${t.timestamp?.toDate().toLocaleString()}</p>
                    <div class="neumo-card neumo-inset p-5 space-y-3 text-left">
                        <div class="flex justify-between"><span class="text-xs font-bold text-gray-400 uppercase">Monto</span><span class="font-bold text-success text-lg">$${t.amount.toLocaleString()}</span></div>
                        <div class="flex justify-between"><span class="text-xs font-bold text-gray-400 uppercase">Estado</span><span class="font-bold ${statusColor} uppercase text-sm">${statusText}</span></div>
                        ${t.prevBalance ? `<div class="flex justify-between border-t border-gray-200 pt-2"><span class="text-xs text-gray-400">Saldo Anterior</span><span class="text-xs font-mono">$${t.prevBalance}</span></div>` : ''}
                        <div class="flex justify-between border-t border-gray-200 pt-2"><span class="text-xs font-bold text-gray-400 uppercase">Descripción</span><span class="text-xs font-medium text-gray-700">${t.description}</span></div>
                    </div>
                    <button onclick="openUserHistory('${uid}', '${email}')" class="neumo-button mt-4 w-full bg-gray-900 text-white py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Volver al Expediente</button>
                </div>`;

            // --- DISEÑO PARA COMPRAS (PURCHASE) ---
            } else if (t.type === 'purchase' && t.details) {
                const item = t.details;
                // Generar HTML de credenciales según si es Libro o Cuenta
                let infoProducto = '';
                if (item.link) {
                    infoProducto = `<div class="neumo-card neumo-inset p-3 mb-2"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Enlace</p><a href="${item.link}" target="_blank" class="text-sm font-bold text-blue-600 underline truncate block">${item.link}</a></div>`;
                } else {
                    infoProducto = `
                    <div class="grid gap-3">
                        <div class="neumo-card neumo-inset p-3"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Correo</p><p class="font-mono text-sm text-gray-800 font-bold select-all break-all">${item.email || 'N/A'}</p></div>
                        <div class="neumo-card neumo-inset p-3"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Contraseña</p><p class="font-mono text-sm text-gray-800 font-bold select-all">${item.password || 'N/A'}</p></div>
                        ${item.profileName ? `<div class="grid grid-cols-2 gap-2"><div class="neumo-card neumo-inset p-3"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Perfil</p><p class="text-sm font-bold text-gray-800">${item.profileName}</p></div><div class="neumo-card neumo-inset p-3"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">PIN</p><p class="text-sm font-bold text-gray-800">${item.pin}</p></div></div>` : ''}
                    </div>
                    <div class="grid grid-cols-2 gap-4 pt-2">
                        <div><p class="text-[10px] font-bold text-gray-400 uppercase">Expira</p><p class="text-sm font-bold text-gray-700">${item.expiryDate || 'N/A'}</p></div>
                        <div><p class="text-[10px] font-bold text-gray-400 uppercase">Duración</p><p class="text-sm font-bold text-gray-700">${item.duration || 'N/A'}</p></div>
                    </div>`;
                }

                modalContent = `
                <div class="text-center bounce-enter pt-4">
                    <div class="w-16 h-16 bg-success/10 text-success rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset"><i data-lucide="shopping-bag" class="w-8 h-8"></i></div>
                    <h3 class="text-xl font-bold text-gray-800 mb-1">Detalle de Compra</h3>
                    <p class="text-xs text-gray-400 mb-6">${t.timestamp?.toDate().toLocaleString()}</p>

                    <div class="neumo-card neumo-inset p-5 text-left space-y-4 relative overflow-hidden mb-4">
                        <div class="absolute top-0 left-0 w-1 h-full bg-success"></div>
                        <div><p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Producto</p><p class="text-lg font-black text-gray-800">${item.serviceName || t.description}</p></div>
                        <div class="flex justify-between items-center border-b border-gray-200 pb-2">
                            <span class="text-xs font-bold text-gray-400 uppercase">Costo</span>
                            <span class="font-bold text-gray-800 text-lg">$${t.amount.toLocaleString()}</span>
                        </div>
                        ${infoProducto}
                    </div>
                    <button onclick="openUserHistory('${uid}', '${email}')" class="neumo-button w-full bg-gray-900 text-white py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Volver al Expediente</button>
                </div>`;
            } else {
                // Generico
                modalContent = `<div class="p-5 text-center"><p class="text-gray-600 font-bold mb-2">${t.description}</p><p class="text-sm">$${t.amount}</p><button onclick="openUserHistory('${uid}', '${email}')" class="neumo-button mt-4 w-full bg-gray-900 text-white py-3 rounded-xl">Volver</button></div>`;
            }

            openModal(modalContent);
        };
        

        // --- MODAL INVITAR ---
        window.openInviteModal = () => {
            const link = `${window.location.origin}${window.location.pathname}?ref=${currentUser.uid}`;
            openModal(`
                <div class="text-center bounce-enter">
                    <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset"><i data-lucide="users" class="w-8 h-8"></i></div>
                    <h3 class="text-xl font-bold text-gray-800 mb-1">Invita y Gana</h3>
                    <p class="text-xs text-gray-500 mb-6 px-4">Comparte este enlace. Tu referido recibe <strong>$40</strong> de bienvenida <strong>de tu saldo</strong> y tú ganas el <strong>10%</strong> de sus compras.</p>
                    <div class="neumo-card neumo-inset p-4 mb-4 flex items-center justify-between gap-3">
                        <span class="text-xs font-mono text-gray-600 truncate select-all">${link}</span>
                        <button onclick="navigator.clipboard.writeText('${link}').then(()=>showToast('Enlace copiado','success'))" class="neumo-button text-indigo-600 hover:bg-indigo-50/50 p-2 rounded-lg"><i data-lucide="copy" class="w-4 h-4"></i></button>
                    </div>
                    <button onclick="closeModal()" class="neumo-button w-full bg-gray-900 text-white font-bold py-3 rounded-xl">Entendido</button>
                </div>
            `);
        }

        // --- MODALES DE PRODUCTO CON DOBLE PRECIO ---
                window.openAddProductModal = () => { 
            let optionsHTML = window.categoriesCache.length > 0 ? window.categoriesCache.map(c => `<option value="${c.slug}">${c.name}</option>`).join('') : `<option value="" disabled selected>Crea categorías primero</option>`; 
            openModal(`
                <div class="text-left bounce-enter">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Agregar Artículo</h3>
                    <form onsubmit="saveProduct(event)" class="space-y-4">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Categoría</label><select id="p-category" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required>${optionsHTML}</select></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre</label><input type="text" id="p-name" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">URL Imagen</label><input type="url" id="p-image" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required></div>
                        
                        <div class="neumo-inset p-3 rounded-xl grid grid-cols-2 gap-3">
                            <p class="col-span-2 text-[10px] font-bold text-gray-400 uppercase text-center mb-1">Lista de Precios</p>
                            <div><label class="block text-[10px] font-bold text-gray-500 uppercase">Cliente</label><input type="number" id="p-price-client" class="neumo-flat border border-gray-200 w-full rounded-lg p-2 text-sm" required placeholder="$ Base"></div>
                            <div><label class="block text-[10px] font-bold text-purple-600 uppercase">Vip</label><input type="number" id="p-price-vip" class="neumo-flat border border-purple-200 w-full rounded-lg p-2 text-sm text-purple-700 font-bold" required placeholder="$ Vip"></div>
                            <div><label class="block text-[10px] font-bold text-indigo-600 uppercase">Revendedor</label><input type="number" id="p-price-reseller" class="neumo-flat border border-indigo-200 w-full rounded-lg p-2 text-sm text-indigo-700 font-bold" required placeholder="$ Rev"></div>
                            <div><label class="block text-[10px] font-bold text-amber-600 uppercase">Lider</label><input type="number" id="p-price-leader" class="neumo-flat border border-amber-200 w-full rounded-lg p-2 text-sm text-amber-700 font-bold" required placeholder="$ Lider"></div>
                        </div>

                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Descripción</label><textarea id="p-desc" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm h-20 resize-none"></textarea></div>
                        <button type="submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg mt-2">Guardar Producto</button>
                    </form>
                </div>`); 
        };

        
                window.saveProduct = async (e) => { 
            e.preventDefault(); 
            try { 
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'profiles'), { 
                    category: document.getElementById('p-category').value, 
                    name: document.getElementById('p-name').value, 
                    imageUrl: document.getElementById('p-image').value, 
                    // AQUÍ GUARDAMOS LOS 4 PRECIOS
                    priceClient: Number(document.getElementById('p-price-client').value), 
                    priceVip: Number(document.getElementById('p-price-vip').value),
                    priceReseller: Number(document.getElementById('p-price-reseller').value),
                    priceLeader: Number(document.getElementById('p-price-leader').value),
                    price: Number(document.getElementById('p-price-client').value), // Mantenemos este por compatibilidad
                    description: document.getElementById('p-desc').value, 
                    stock: 0, 
                    createdAt: serverTimestamp() 
                }); 
                showToast('Producto agregado correctamente', 'success'); 
                closeModal(); 
            } catch(err) { showToast('Error al guardar', 'error'); } 
        };

        
                // Reemplaza la función existente con esta versión mejorada
        window.openEditProductModal = async (pid) => { 
            // 1. Obtener datos del producto
            const docSnap = await getDoc(doc(db,'artifacts',appId,'public','data','profiles',pid));
            if (!docSnap.exists()) return showToast('Producto no encontrado', 'error');
            const d = docSnap.data(); 

            // 2. Generar opciones de categoría
            let optionsHTML = window.categoriesCache.map(c => `<option value="${c.slug}" ${c.slug===d.category?'selected':''}>${c.name}</option>`).join(''); 

            // 3. Obtener los valores actuales de los precios (usando un fallback si no existen)
            // Se usa d.priceClient o d.price como base si los específicos no existen aún.
            const valClient = d.priceClient || d.price || 0;
            const valVip = d.priceVip || valClient || 0;
            const valReseller = d.priceReseller || valClient || 0;
            const valLeader = d.priceLeader || valReseller || 0;

            // 4. Abrir el modal con el NUEVO diseño de rejilla de precios
            openModal(`
                <div class="text-left bounce-enter">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Editar Producto</h3>
                    <form onsubmit="updateProduct(event, '${pid}')" class="space-y-4">
                        
                        <div><label class="text-xs font-bold uppercase text-gray-500">Nombre</label><input type="text" id="e-name" value="${d.name}" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required></div>

                        <div class="neumo-inset p-3 rounded-xl grid grid-cols-2 gap-3">
                            <p class="col-span-2 text-[10px] font-bold text-gray-400 uppercase text-center mb-1">Precios por Jerarquía</p>
                            
                            <div><label class="block text-[10px] font-bold text-gray-500 uppercase">Cliente</label><input type="number" id="e-price-client" value="${valClient}" class="neumo-flat border border-gray-200 w-full rounded-lg p-2 text-sm" required step="0.01"></div>
                            
                            <div><label class="block text-[10px] font-bold text-purple-600 uppercase">Vip</label><input type="number" id="e-price-vip" value="${valVip}" class="neumo-flat border border-purple-200 w-full rounded-lg p-2 text-sm text-purple-700 font-bold" required step="0.01"></div>
                            
                            <div><label class="block text-[10px] font-bold text-indigo-600 uppercase">Revendedor</label><input type="number" id="e-price-reseller" value="${valReseller}" class="neumo-flat border border-indigo-200 w-full rounded-lg p-2 text-sm text-indigo-700 font-bold" required step="0.01"></div>
                            
                            <div><label class="block text-[10px] font-bold text-amber-600 uppercase">Lider</label><input type="number" id="e-price-leader" value="${valLeader}" class="neumo-flat border border-amber-200 w-full rounded-lg p-2 text-sm text-amber-700 font-bold" required step="0.01"></div>
                        </div>
                        <div><label class="text-xs font-bold uppercase text-gray-500">Categoría</label><select id="e-cat" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm">${optionsHTML}</select></div>
                        <div><label class="text-xs font-bold uppercase text-gray-500">URL Imagen</label><input type="url" id="e-img" value="${d.imageUrl}" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required></div>
                        <div><label class="text-xs font-bold uppercase text-gray-500">Descripción</label><textarea id="e-desc" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 h-24 resize-none">${d.description}</textarea></div>
                        
                        <button type="submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg mt-2">Guardar Cambios</button>
                    </form>
                </div>`); 
        };

                // Reemplaza la función existente con esta versión para guardar los 4 precios
        window.updateProduct = async (e, pid) => { 
            e.preventDefault(); 

            // Validar inputs numéricos
            const pClient = Number(document.getElementById('e-price-client').value);
            const pVip = Number(document.getElementById('e-price-vip').value);
            const pReseller = Number(document.getElementById('e-price-reseller').value);
            const pLeader = Number(document.getElementById('e-price-leader').value);

            if (isNaN(pClient) || isNaN(pVip) || isNaN(pReseller) || isNaN(pLeader)) {
                return showToast('Por favor, ingresa valores numéricos válidos para los precios.', 'error');
            }

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Guardando...";

            try {
                await updateDoc(doc(db,'artifacts',appId,'public','data','profiles',pid), { 
                    name: document.getElementById('e-name').value, 
                    
                    // --- ACTUALIZAMOS LOS 4 PRECIOS ---
                    priceClient: pClient,
                    priceVip: pVip,
                    priceReseller: pReseller,
                    priceLeader: pLeader,
                    price: pClient, // Mantenemos 'price' genérico igual al de cliente por compatibilidad
                    // ----------------------------------

                    category: document.getElementById('e-cat').value, 
                    imageUrl: document.getElementById('e-img').value, 
                    description: document.getElementById('e-desc').value,
                    updatedAt: serverTimestamp()
                }); 

                showToast('Producto actualizado correctamente', 'success'); 
                closeModal(); 
            } catch (error) {
                console.error("Error al actualizar producto:", error);
                showToast('Error al guardar cambios: ' + error.message, 'error');
                btn.disabled = false;
                btn.innerText = originalText;
            }
        };

        // --- COMPRA Y NAVEGACIÓN ---
        window.openCategoryModule = (categorySlug, title) => {
            const html = `<div class="relative h-full flex flex-col bg-bg-primary"><div class="neumo-flat flex justify-between items-center mb-4 px-6 pt-6"><div><h3 class="text-2xl font-black text-gray-800 tracking-tight">${title}</h3><p class="text-xs text-gray-400 font-medium">Selecciona tu plan ideal</p></div></div><div class="overflow-y-auto flex-1 pb-24 px-4 scrollbar-hide"><div id="products-grid" class="grid grid-cols-2 gap-4 pb-4"><div class="col-span-full text-center py-20"><div class="inline-block w-8 h-8 border-4 border-gray-200 border-t-accent rounded-full animate-spin"></div></div></div></div></div>`;
            document.getElementById('modal-content').innerHTML = html; const m = document.getElementById('app-modal'); const mc = document.getElementById('modal-card'); m.classList.remove('items-center', 'justify-center', 'p-4'); m.classList.add('items-end', 'justify-center', 'p-0'); mc.className = "neumo-card w-full max-w-4xl h-[85vh] rounded-t-[2.5rem] relative shadow-[0_-10px_40px_rgba(0,0,0,0.1)] flex flex-col overflow-hidden slide-up border-t border-gray-100"; m.classList.remove('hidden'); m.classList.add('flex');
            
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'profiles'), where('category', '==', categorySlug));
            
            onSnapshot(q, (snapshot) => {
                const grid = document.getElementById('products-grid'); if(!grid) return; if(snapshot.empty) { grid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-12 opacity-50"><i data-lucide="package-open" class="w-12 h-12 mb-2"></i><p class="text-sm">No hay productos en ${title}.</p></div>`; lucide.createIcons(); return; }
                grid.innerHTML = ''; 
                snapshot.forEach(doc => { 
                                        const p = doc.data(); 
                    const safeDesc = encodeURIComponent(p.description || ''); 
                    
                    // --- LÓGICA: ELEGIR PRECIO SEGÚN JERARQUÍA ---
                    let effectivePrice = p.priceClient || p.price; // Precio base
                    
                    // Si el usuario tiene rango y el producto tiene precio especial, úsalo
                    if (currentUserRole === 'lider' && p.priceLeader) effectivePrice = p.priceLeader;
                    else if (currentUserRole === 'reseller' && p.priceReseller) effectivePrice = p.priceReseller;
                    else if (currentUserRole === 'vip' && p.priceVip) effectivePrice = p.priceVip;

                    // --- LÓGICA: ESTILO DEL PRECIO E ICONO ---
                    const roleInfo = getRoleData(currentUserRole);
                    let priceClass = 'bg-gray-100 text-gray-800'; // Estilo normal
                    let label = '';

                    // Si NO es cliente normal, ponemos colores e icono
                    if (currentUserRole !== 'client') {
                        priceClass = `${roleInfo.bg} ${roleInfo.color} border border-current/20`;
                        label = `<span class="text-[8px] uppercase font-bold opacity-80 block mb-0.5 flex items-center gap-1"><i data-lucide="${roleInfo.icon}" class="w-2 h-2"></i> ${roleInfo.label}</span>`;
                    }

                    // Renderizado de tarjeta
                                        // CÓDIGO NUEVO: Listón de "Agotado" estilo esquina sin desenfoque
                    let ribbon = ((p.stock || 0) <= 0)
                        ? `<div class="absolute top-0 left-0 z-20 w-[100px] h-[100px] overflow-hidden pointer-events-none">
                                <div class="bg-danger shadow-md text-white text-[10px] tracking-wider font-black uppercase py-1.5 text-center transform -rotate-45 absolute top-[20px] -left-[35px] w-[140px] neumo-flat" style="box-shadow: 0 5px 10px rgba(0,0,0,0.2);">
                                    AGOTADO
                                </div>
                           </div>`
                        : (((p.stock || 0) <= 3) ? `<div class="absolute top-2 right-2 bg-accent text-white text-[10px] font-bold px-2 py-0.5 rounded-lg shadow-sm z-20 neumo-flat">¡Pocos!</div>` : ''); 
                    
                    const card = document.createElement('div'); card.className = "neumo-card overflow-hidden cursor-pointer group hover:scale-105 relative bounce-enter"; 
                    card.innerHTML = `${ribbon}<div onclick="buyProduct('${doc.id}', '${p.name}', ${effectivePrice}, ${p.stock||0}, '${safeDesc}', '${p.imageUrl}')" class="flex flex-col h-full"><div class="aspect-[4/3] overflow-hidden bg-gray-100 relative"><img src="${p.imageUrl}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" loading="lazy"><div class="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-black/50 to-transparent opacity-60"></div></div><div class="p-4 flex-1 flex flex-col justify-between"><div><h4 class="font-bold text-gray-800 text-sm leading-tight mb-1">${p.name}</h4><p class="text-[10px] text-gray-400 line-clamp-2">${p.description || 'Servicio digital premium'}</p></div><div class="flex justify-between items-end mt-3"><div class="${priceClass} px-2.5 py-1 rounded-lg text-right neumo-flat min-w-[70px]">${label}<span class="font-bold text-sm">$${effectivePrice}</span></div><div class="neumo-button w-8 h-8 rounded-full bg-bg-primary flex items-center justify-center group-hover:bg-gray-900 group-hover:text-white"><i data-lucide="shopping-bag" class="w-4 h-4"></i></div></div></div></div>`; 
                    grid.appendChild(card); 
 
                }); 
                lucide.createIcons();
            });
        };

        window.buyProduct = (id, name, price, stock, desc, imgUrl) => { 
            openModal(`
                <div class="text-center bounce-enter">
                    <div class="mx-auto mb-4 w-24 h-24 relative">
                        <img src="${imgUrl}" class="w-full h-full rounded-2xl object-cover shadow-md bg-gray-100 neumo-card">
                        <div class="neumo-button absolute -bottom-2 -right-2 bg-gray-900 text-white p-1.5 rounded-xl shadow-lg border-2 border-bg-primary"><i data-lucide="shopping-bag" class="w-4 h-4"></i></div>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-1">${name}</h3>
                    <p class="text-success font-bold text-lg mb-1">$${price.toLocaleString()} <span class="text-xs text-gray-400 font-normal">MXN</span></p>
                    
                    <p class="text-xs text-gray-500 font-medium mb-6">Stock disponible: <span class="text-gray-800 font-bold">${stock}</span></p>

                    <div class="neumo-card neumo-inset p-4 rounded-2xl text-left mb-6"><p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Incluye</p><p class="text-sm text-gray-600 leading-relaxed">${decodeURIComponent(desc)}</p></div>
                    <button onclick="processPurchase('${id}', '${name}',${price})" class="neumo-button w-full bg-gray-900 text-white font-bold py-4 rounded-2xl shadow-xl hover:bg-gray-800 active:scale-95 transition-all flex items-center justify-center gap-2" ${stock <= 0 ? 'disabled style="opacity:0.5; pointer-events:none;"' : ''}>${stock <= 0 ? 'Agotado' : `Confirmar Compra <i data-lucide="chevron-right" class="w-4 h-4"></i>`}</button>
                </div>
            `);
        };

        window.processPurchase = async (pid, name, visualPrice) => {
            if(!currentUser) return showToast('Inicia sesión', 'error');
            const btn = document.querySelector('button[onclick^="processPurchase"]'); btn.disabled = true; btn.innerHTML = `<span class="animate-spin">⌛</span>`;
            try {
                // Buscamos un item disponible
                const qInv = query(collection(db, 'artifacts', appId, 'public', 'data', 'inventory_items'), where('productId', '==', pid), where('status', '==', 'available'), limit(1));
                const invSnap = await getDocs(qInv); 
                
                // Si está vacío, lanzamos error
                if(invSnap.empty) throw new Error("Stock agotado");
                
                const item = invSnap.docs[0].data(); 
                const itemId = invSnap.docs[0].id;

                await runTransaction(db, async (t) => {
                    const wRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'wallet', 'main'); 
                    const wSnap = await t.get(wRef);
                    const currentBalance = Number(wSnap.data().balance) || 0;
                    
                                        // Obtener datos del producto
                    const pRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', pid); 
                    const pSnap = await t.get(pRef);
                    const productData = pSnap.data();
                    
                    // Determinar precio base
                    let finalPrice = productData.priceClient || productData.price;
                    
                    // Aplicar descuento según jerarquía
                    if (currentUserRole === 'lider' && productData.priceLeader) {
                        finalPrice = productData.priceLeader;
                    } else if (currentUserRole === 'reseller' && productData.priceReseller) {
                        finalPrice = productData.priceReseller;
                    } else if (currentUserRole === 'vip' && productData.priceVip) {
                        finalPrice = productData.priceVip;
                    }
                    
                    const cost = Number(finalPrice);
                    
                    if(currentBalance < cost) throw new Error("Saldo insuficiente");
                    
                    const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', currentUser.uid);
                    const userDocSnap = await t.get(userDocRef);
                    const referrerId = userDocSnap.exists() ? userDocSnap.data().referredBy : null;

                    // Crear detalles incluyendo campos nuevos si existen
                    const purchaseDetails = { 
                        serviceName: item.serviceName, 
                        email: item.email || null, // Puede ser null en libros
                        link: item.link || null,   // Nuevo campo Libros
                        password: item.password, 
                        expiryDate: item.expiryDate || null, 
                        duration: item.duration || null, 
                        profileName: item.profileName || null, // Nuevo campo Cuentas
                        pin: item.pin || null, // Nuevo campo Cuentas
                        terms: item.terms || '' 
                    };

                    // Descontar saldo
                    t.update(wRef, { balance: (currentBalance - cost) });
                    
                    // --- MODIFICACION: SOLO DESCONTAR STOCK SI NO ES LIBRO ---
                                        // --- MODIFICACION: SOLO DESCONTAR STOCK SI NO ES LIBRO NI DOCUMENTO ---
                                        // --- LÓGICA DE STOCK INFINITO ---
                    // Lista de categorías que NUNCA se agotan ni se marcan como vendidas
                    const infiniteCategories = ['libros', 'documentos', 'herramientas', 'cursos'];

                    if (!infiniteCategories.includes(productData.category)) {
                        // SI NO ES INFINITO (Ej: Netflix):
                        // 1. Marcar el item específico como "Vendido" para que nadie más lo tome
                        t.update(doc(db, 'artifacts', appId, 'public', 'data', 'inventory_items', itemId), { status: 'sold', soldTo: currentUser.uid, soldAt: serverTimestamp() });
                        
                        // 2. Restar 1 al stock visible del producto
                        t.update(pRef, { stock: (productData.stock || 0) - 1 });
                    }
                    // Si ES infinito (Herramientas), no hacemos nada aquí, el item sigue "available"


                    // ---------------------------------------------------------

                    t.set(doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions')), { type: 'purchase', amount: cost, description: `Compra: ${name}`, details: purchaseDetails, itemId: itemId, timestamp: serverTimestamp() });

                    if (referrerId) {
                        const commission = cost * REFERRAL_COMMISSION_RATE; 
                        const resellerWalletRef = doc(db, 'artifacts', appId, 'users', referrerId, 'wallet', 'main');
                        const resellerSnap = await t.get(resellerWalletRef);
                        if(resellerSnap.exists()) {
                            t.update(resellerWalletRef, { profit: (resellerSnap.data().profit || 0) + commission });
                        }
                    }
                });
                showToast('¡Compra exitosa!', 'success'); showTicketModal({...item, serviceName: name});
            } catch (e) { let m = e.message || "Error"; if(m.includes("Saldo")) openChargeModal(); showToast(m, 'error'); closeModal(); }
        };

        window.showTicketModal = (item) => {
            const terms = item.terms || "Sin términos adicionales.";
            const safeTerms = encodeURIComponent(terms); 
            
            // Lógica para mostrar Link (Libro) o Credenciales
            let mainContent = '';
            
            if (item.link) {
                // Es un Libro
                mainContent = `
                    <div class="neumo-card neumo-inset p-3 mb-2"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Enlace de Descarga</p><a href="${item.link}" target="_blank" class="text-sm font-bold text-blue-600 underline truncate block">${item.link}</a></div>
                    <div class="neumo-card neumo-inset p-3"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Contraseña</p><p class="font-mono text-sm text-gray-800 font-bold select-all">${item.password}</p></div>
                `;
            } else {
                // Es Cuenta/Perfil
                mainContent = `
                    <div class="grid gap-3">
                        <div class="neumo-card neumo-inset p-3"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Correo</p><p class="font-mono text-sm text-gray-800 font-bold select-all break-all">${item.email}</p></div>
                        <div class="neumo-card neumo-inset p-3"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Contraseña</p><p class="font-mono text-sm text-gray-800 font-bold select-all">${item.password}</p></div>
                        ${item.profileName ? `<div class="grid grid-cols-2 gap-2"><div class="neumo-card neumo-inset p-3"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Perfil</p><p class="text-sm font-bold text-gray-800">${item.profileName}</p></div><div class="neumo-card neumo-inset p-3"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">PIN</p><p class="text-sm font-bold text-gray-800">${item.pin}</p></div></div>` : ''}
                    </div>
                    <div class="grid grid-cols-2 gap-4 pt-2">
                        <div><p class="text-[10px] font-bold text-gray-400 uppercase">Expira</p><p class="text-sm font-bold text-gray-700">${item.expiryDate || 'N/A'}</p></div>
                        <div><p class="text-[10px] font-bold text-gray-400 uppercase">Duración</p><p class="text-sm font-bold text-gray-700">${item.duration || 'N/A'}</p></div>
                    </div>
                `;
            }

            openModal(`
                <div class="text-center bounce-enter pt-4">
                    <div class="w-16 h-16 bg-success/10 text-success rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset"><i data-lucide="check" class="w-8 h-8"></i></div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">¡Compra Exitosa!</h3>
                    <p class="text-xs text-gray-400 mb-6">Captura o copia tu ticket</p>
                    
                    <div class="neumo-card neumo-inset p-5 text-left space-y-4 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-success"></div>
                        <div><p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Producto</p><p class="text-lg font-black text-gray-800">${item.serviceName}</p></div>
                        
                        ${mainContent}
                        
                        <div class="pt-3 border-t border-dashed border-gray-200"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Términos y Condiciones</p><p class="text-[10px] text-gray-500 leading-relaxed italic">${terms}</p></div>
                    </div>

                    <div class="mt-6 space-y-3">
                        <button onclick="copyTicketData('${item.serviceName}', '${item.email||item.link}', '${item.password}', '${item.expiryDate||''}', '${item.duration || ''}', '${item.profileName || ''}', '${item.pin || ''}', '${safeTerms}')" class="neumo-button w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg flex items-center justify-center gap-2"><i data-lucide="copy" class="w-4 h-4"></i> Copiar Ticket</button>
                        <button onclick="closeModal()" class="neumo-button w-full text-gray-500 font-bold text-xs py-2 hover:text-gray-800">Cerrar</button>
                    </div>
                </div>
            `);
        };

        window.copyTicketData = (srv, mailOrLink, pass, exp, dur, profile, pin, encTerms) => {
    const terms = decodeURIComponent(encTerms);
    let text = `📦 *COMPRA EXITOSA - STREAM EVOLUTION*\n\n📌 *Producto:* ${srv}\n`;
    
    if(mailOrLink.includes('http')) {
            text += `🔗 *Link:* ${mailOrLink}\n`;
    } else {
            text += `📧 *Correo:* ${mailOrLink}\n`;
    }
    
    text += `🔑 *Contraseña:* ${pass}\n`;

    // --- NUEVO CÓDIGO AGREGADO ---
    if(profile && profile !== 'null' && profile !== 'undefined' && profile !== '') {
        text += `👤 *Perfil:* ${profile}\n`;
    }
    if(pin && pin !== 'null' && pin !== 'undefined' && pin !== '') {
        text += `🔒 *PIN:* ${pin}\n`;
    }
    // ----------------------------
    
    if(exp) text += `📅 *Expira:* ${exp}\n`;
    if(dur) text += `⏳ *Duración:* ${dur}\n`;
    
    text += `\n📜 *Términos:* ${terms}\n\n¡Gracias por tu preferencia!`;
    
    navigator.clipboard.writeText(text).then(() => showToast('¡Ticket copiado!', 'success')).catch(() => showToast('Error al copiar', 'error'));
};
        
        // --- NOTIFICACIONES ---
        window.openNotifications = () => { 
            const d = document.getElementById('notification-dot'); if(d) d.style.display='none'; 
            let h=`<div class="text-center mb-4"><h3 class="text-xl font-bold text-gray-800">Notificaciones</h3><p class="text-xs text-gray-400">Actividad Reciente</p></div><div class="space-y-3">`; 
            let all=[...window.globalNotifications, ...window.userTransactions]; 
            if(isAdmin){all=[...all,...window.adminPendingRequests, ...window.adminPendingReports, ...window.adminPendingRenewals]} 
            all.sort((a,b)=>(b.timestamp?.toMillis()||0)-(a.timestamp?.toMillis()||0)); 
            if(all.length===0)h+=`<p class="text-center text-gray-400 py-8">Sin actividad reciente</p>`; 
            else all.forEach(t=>{ 
                let icon='circle', color='text-gray-400', bg='bg-gray-100';
                let desc = t.title||t.description||t.email;
                if(t.type==='deposit'){
                    if(t.status==='Pending'||t.status==='pending'||t.status==='Pendiente'){ icon='clock'; color='text-accent'; bg='bg-accent/10'; desc = 'Recarga Pendiente'; } else if (t.status === 'rejected' || t.status === 'cancelled' || t.status === 'Rechazado' || t.status === 'Cancelado') { icon='x-circle'; color='text-danger'; bg='bg-danger/10'; desc = 'Recarga Cancelada'; } else { icon='check-circle'; color='text-success'; bg='bg-success/10'; desc = 'Recarga Exitosa'; }
                } else if(t.type==='purchase'){ icon='shopping-bag'; color='text-gray-600'; bg='bg-gray-200'; }
                else if(t.type==='charge'){ icon='alert-octagon'; color='text-rose-600'; bg='bg-rose-100'; }
                else if(t.type==='support_reply'){ icon='message-circle'; color='text-blue-500'; bg='bg-blue-100'; }
                else if(t.type==='renewal'){ icon='refresh-cw'; color='text-indigo-500'; bg='bg-indigo-100'; desc = 'Solicitud de Renovación'; }
                else if(t.isGlobal){ icon='bell'; color='text-indigo-500'; bg='bg-indigo-100'; }
                h+=`<div onclick="openTransactionDetail('${t.id}')" class="neumo-card p-3 flex justify-between items-center cursor-pointer hover:scale-105 transition-transform group"> <div class="flex items-center gap-3"> <div class="w-10 h-10 rounded-xl ${bg} flex items-center justify-center ${color} shadow-sm neumo-inset"><i data-lucide="${icon}" class="w-5 h-5"></i></div> <div><p class="font-bold text-xs text-gray-700 line-clamp-1">${desc}</p><p class="text-[10px] text-gray-400">${t.timestamp?.toDate().toLocaleString()}</p></div> </div> </div>`;
            }); 
            h+=`</div>`; openModal(h); 
        };
        window.openTransactionDetail = (id) => {
            let t = window.userTransactions.find(x => x.id === id) || window.globalNotifications.find(x => x.id === id) || window.adminPendingRequests.find(x => x.id === id) || window.adminPendingRenewals.find(x => x.id === id); 
            if(!t) return;
            if(t.type === 'deposit') {
                let statusColor = 'text-success'; let statusText = 'Éxito';
                if(t.status==='Pending'||t.status==='pending'||t.status==='Pendiente'){ statusColor = 'text-accent'; statusText = 'Pendiente'; } 
                else if (t.status === 'rejected' || t.status === 'cancelled' || t.status === 'Rechazado' || t.status === 'Cancelado') { statusColor = 'text-danger'; statusText = 'Cancelado'; }
                openModal(` <div class="text-center bounce-enter pt-4"> <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset"><i data-lucide="dollar-sign" class="w-8 h-8 text-gray-500"></i></div> <h3 class="text-xl font-bold text-gray-800 mb-1">Detalle de Recarga</h3> <p class="text-xs text-gray-400 mb-6">${t.timestamp?.toDate().toLocaleString()}</p> <div class="neumo-card neumo-inset p-5 space-y-3 text-left"> <div class="flex justify-between"><span class="text-xs font-bold text-gray-400 uppercase">Monto</span><span class="font-bold text-success text-lg">$${t.amount}</span></div> <div class="flex justify-between"><span class="text-xs font-bold text-gray-400 uppercase">Estado</span><span class="font-bold ${statusColor} uppercase text-sm">${statusText}</span></div> ${t.prevBalance ? `<div class="flex justify-between border-t border-gray-200 pt-2"><span class="text-xs text-gray-400">Saldo Anterior</span><span class="text-xs font-mono">$${t.prevBalance}</span></div>` : ''} </div> <button onclick="openNotifications()" class="neumo-button mt-4 text-gray-500 text-xs font-bold hover:text-gray-800">Volver</button> </div> `);
            } else if (t.type === 'purchase' && t.details) { showTicketModal({...t.details, serviceName: t.description}); } else if (t.type === 'support_reply') { openSupportReplyDetail(t.id); } else if (t.type === 'renewal') { if (isAdmin) { viewRenewalDetail(t.id); } else { openModal(`<div class="p-4 text-center"><p class="text-gray-500">Solicitud de Renovación enviada al administrador.</p><p class="text-xs text-gray-400 mt-2">${t.description}</p></div>`); } } else { openModal(`<div class="p-4 text-center"><p class="text-gray-500">${t.description || t.message || t.title}</p></div>`); }
        };

        // --- CARGA SALDO CON TIMER Y SANCIÓN (NUEVO) ---
        window.openChargeModal = () => { 
            openModal(`
                <div class="text-center bounce-enter">
                    <div class="w-16 h-16 bg-accent/10 text-accent rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset"><i data-lucide="wallet" class="w-8 h-8"></i></div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Cargar Saldo</h3>
                    <input type="number" id="charge-amount" class="neumo-inset w-full bg-transparent border-none rounded-xl px-4 py-3 text-lg font-bold text-center mb-4" placeholder="$0">
                    <button id="confirm-btn" onclick="processRecharge(document.getElementById('charge-amount').value)" class="neumo-button w-full bg-accent text-white font-bold py-3 rounded-xl shadow-accent">Solicitar</button>
                    <div id="payment-info-container"></div>
                </div>
            `); 
        };

        window.processRecharge = async (amt) => {
            if (!amt) return;
            const btn = document.getElementById('confirm-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<div class="w-4 h-4 border-2 border-gray-900 border-t-transparent rounded-full animate-spin"></div>`;
            btn.disabled = true;

            try {
                // 1. Verificar sanciones previas (opcional, resetear contador si es otro día)
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', currentUser.uid);
                const userSnap = await getDoc(userDocRef);
                let strikes = userSnap.data().rechargeStrikes || 0;
                let lastStrike = userSnap.data().lastStrikeDate ? userSnap.data().lastStrikeDate.toDate() : new Date();
                
                // Resetear strikes si es un día nuevo
                const today = new Date();
                if(lastStrike.getDate() !== today.getDate() || lastStrike.getMonth() !== today.getMonth()) {
                    strikes = 0;
                    await updateDoc(userDocRef, { rechargeStrikes: 0 });
                }

                // 2. Crear la solicitud
                const txRef = await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), {
                    type: 'deposit',
                    amount: Number(amt),
                    description: 'Recarga Pendiente (En proceso)',
                    timestamp: serverTimestamp(),
                    status: 'Pending'
                });

                const reqRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pending_recharges'), {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    amount: Number(amt),
                    status: 'pending',
                    timestamp: serverTimestamp(),
                    userTxId: txRef.id,
                    expiresAt: new Date(Date.now() + 10 * 60 * 1000) // 10 minutos futuro
                });

                showToast('Solicitud iniciada. Tienes 10 minutos.', 'info');
                
                // 3. Abrir Modal con Timer
                showPaymentModalWithTimer(reqRef.id, txRef.id, Number(amt), strikes);

            } catch (e) {
                console.error(e);
                showToast('Error al procesar solicitud', 'error');
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        window.showPaymentModalWithTimer = (reqId, txId, amount, strikes) => {
            // Referencia aleatoria para identificar el pago
            const refCode = `RW${Math.floor(Math.random() * 10000)}`;
            const strikeWarning = strikes >= 2 
                ? `<p class="text-rose-500 font-bold text-xs mt-2 animate-pulse">⚠️ ADVERTENCIA: Llevas ${strikes} cancelaciones hoy. Si esta se cancela, se te descontarán $50.</p>` 
                : `<p class="text-gray-400 text-[10px] mt-2">Intentos fallidos hoy: ${strikes}/3</p>`;

            openModal(`
                <div class="text-center bounce-enter pt-2">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-2">
                        <h3 class="text-lg font-bold text-gray-800">Completar Pago</h3>
                        <div id="countdown-timer" class="text-xl font-black text-rose-500 font-mono bg-rose-50 px-3 py-1 rounded-lg border border-rose-100">10:00</div>
                    </div>

                    <div class="neumo-card neumo-inset p-4 text-left space-y-3 mb-4">
                        <p class="text-xs font-bold text-accent uppercase flex items-center gap-2"><i data-lucide="landmark" class="w-4 h-4"></i> Datos Bancarios</p>
                        
                        <div class="bg-white/50 p-3 rounded-lg border border-gray-100 space-y-2 text-sm">
                            <div class="flex justify-between"><span class="text-gray-500">Banco:</span><span class="font-bold">STP / Transferencia</span></div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-500">Cuenta CLABE:</span>
                                <div class="flex gap-2 items-center">
                                    <span class="font-mono font-bold select-all">646180402324335362</span>
                                    <i data-lucide="copy" class="w-3 h-3 text-gray-400 cursor-pointer" onclick="navigator.clipboard.writeText('646180402324335362'); showToast('Copiado','success')"></i>
                                </div>
                            </div>
                            <div class="flex justify-between"><span class="text-gray-500">Beneficiario:</span><span class="font-bold">AXLL</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Monto exacto:</span><span class="font-black text-success">$${amount.toLocaleString()}</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Concepto/Ref:</span><span class="font-mono font-bold bg-gray-200 px-1 rounded">${refCode}</span></div>
                        </div>
                    </div>

                    <div class="bg-yellow-50 p-3 rounded-xl border border-yellow-100 text-left mb-4">
                        <p class="text-xs text-yellow-800 font-bold flex items-center gap-1"><i data-lucide="alert-circle" class="w-4 h-4"></i> Importante</p>
                        <p class="text-[10px] text-yellow-700 mt-1 leading-tight">
                            Tienes 10 minutos para realizar la transferencia. Si el tiempo expira, la solicitud se cancelará automáticamente.
                        </p>
                        ${strikeWarning}
                    </div>

                    <button onclick="closeModal()" class="neumo-button w-full bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg mb-2">Ya realicé el pago</button>
                    <button onclick="cancelRechargeRequest('${reqId}', '${txId}', false)" class="neumo-button w-full text-rose-500 text-xs font-bold py-2">Cancelar Solicitud</button>
                </div>
            `);
            lucide.createIcons();
            startPaymentTimer(reqId, txId);
        };

        window.startPaymentTimer = (reqId, txId) => {
            let timeLeft = 600; // 10 minutos en segundos
            const display = document.getElementById('countdown-timer');
            
            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                if (!document.getElementById('countdown-timer')) {
                    clearInterval(timerInterval); // Detener si el modal se cierra
                    return;
                }

                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                display.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    display.textContent = "00:00";
                    cancelRechargeRequest(reqId, txId, true); // true = fue por timeout
                }
            }, 1000);
        };

        window.cancelRechargeRequest = async (reqId, txId, isTimeout) => {
            if (!isTimeout && !confirm("¿Seguro que deseas cancelar? Esto contará como intento fallido.")) return;

            try {
                // 1. Marcar como cancelada en BD
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pending_recharges', reqId), { status: 'cancelled' });
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', txId), { status: 'Cancelado', description: isTimeout ? 'Recarga Expirada (Timeout)' : 'Recarga Cancelada por Usuario' });

                // 2. Lógica de Sanción
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', currentUser.uid);
                
                await runTransaction(db, async (t) => {
                    const userDoc = await t.get(userRef);
                    let newStrikes = (userDoc.data().rechargeStrikes || 0) + 1;
                    
                    // Actualizar contador
                    t.update(userRef, { 
                        rechargeStrikes: newStrikes,
                        lastStrikeDate: serverTimestamp()
                    });

                    // Aplicar multa si llega a 3
                    if (newStrikes >= 3) {
                        const walletRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'wallet', 'main');
                        const walletSnap = await t.get(walletRef);
                        const currentBal = walletSnap.data().balance || 0;

                        t.update(walletRef, { balance: currentBal - 50 });
                        
                        // Registrar transacción de multa
                        const penaltyTx = doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'));
                        t.set(penaltyTx, {
                            type: 'charge',
                            amount: 50,
                            description: 'MULTA: 3 Recargas Fallidas/Canceladas',
                            timestamp: serverTimestamp()
                        });
                        
                        // Resetear strikes tras multa (opcional, o dejar que sufra hoy)
                         t.update(userRef, { rechargeStrikes: 0 }); 
                    }
                });

                if (isTimeout) {
                    alert("⏳ Tiempo agotado. La solicitud ha sido cancelada.");
                } else {
                    showToast("Solicitud cancelada.", "info");
                }
                closeModal();

            } catch (e) {
                console.error("Error al cancelar:", e);
            }
        };

        // --- SOPORTE RESPUESTAS ---
        window.openSupportReplies = () => {
            const replies = window.userTransactions.filter(t => t.type === 'support_reply');
            let html = `<div class="text-center mb-4 bounce-enter"><h3 class="text-xl font-bold text-gray-800">Respuestas de Soporte</h3><p class="text-xs text-gray-400">Toca para leer</p></div>`;
            if (replies.length === 0) { html += `<div class="flex flex-col items-center justify-center py-12 opacity-50"><i data-lucide="message-circle-off" class="w-12 h-12 mb-2 text-gray-300"></i><p class="text-sm text-gray-400">Sin respuestas nuevas</p></div>`; } else { html += `<div class="space-y-3">`; replies.forEach(r => { const time = r.timestamp ? r.timestamp.toDate().toLocaleString() : 'Reciente'; html += ` <div onclick="openSupportReplyDetail('${r.id}')" class="neumo-card neumo-inset p-4 rounded-xl text-left cursor-pointer hover:scale-[0.99] transition-transform group relative"> <div class="flex justify-between items-start mb-2"> <span class="text-xs font-bold text-blue-600 uppercase bg-blue-50/50 px-2 py-0.5 rounded flex items-center gap-1 neumo-flat"><i data-lucide="mail-open" class="w-3 h-3"></i> Respuesta Admin</span> <span class="text-[10px] text-gray-400">${time}</span> </div> <p class="text-sm text-gray-700 line-clamp-2 font-medium">${r.message}</p> <div class="absolute right-3 bottom-3 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="chevron-right" class="w-4 h-4 text-blue-400"></i></div> </div> `; }); html += `</div>`; } openModal(html);
        };
        window.openSupportReplyDetail = (id) => {
            const r = window.userTransactions.find(t => t.id === id); if(!r) return;
            openModal(` <div class="text-left bounce-enter p-1 h-[70vh] flex flex-col"> <div class="flex items-center gap-3 mb-6 border-b border-gray-100 pb-4"> <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center neumo-card neumo-inset"><i data-lucide="message-circle" class="w-5 h-5"></i></div> <div> <h3 class="font-bold text-lg text-gray-800 leading-tight">Mensaje de Soporte</h3> <p class="text-xs text-gray-400">${r.timestamp ? r.timestamp.toDate().toLocaleString() : ''}</p> </div> </div> <div class="neumo-card neumo-inset p-5 rounded-2xl text-sm text-gray-700 whitespace-pre-wrap flex-1 overflow-y-auto leading-relaxed font-medium">${r.message}</div> <button onclick="openSupportReplies()" class="neumo-button mt-4 w-full bg-gray-900 text-white py-3.5 rounded-xl shadow-lg flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Volver</button> </div> `);
        };

        // --- RENOVACIONES CLIENTE ---
        window.openRenewalModal = () => {
            openModal(` <div class="text-center bounce-enter"> <div class="w-16 h-16 bg-indigo-100 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset"><i data-lucide="refresh-cw" class="w-8 h-8"></i></div> <h3 class="text-xl font-bold text-gray-800 mb-2">Renovar Servicio</h3> <p class="text-xs text-gray-400 mb-6 px-4">Ingresa el correo de la cuenta que compraste para verificar disponibilidad.</p> <form onsubmit="searchRenewal(event)" class="relative"> <i data-lucide="search" class="absolute left-4 top-3.5 w-5 h-5 text-gray-300"></i> <input type="email" id="renew-email" class="neumo-inset w-full bg-transparent border-none rounded-2xl py-3.5 pl-12 pr-4 text-gray-700 font-medium placeholder:text-gray-400 focus:ring-0 focus:outline-none" placeholder="ej: cliente@correo.com" required> <button type="submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg mt-4 flex items-center justify-center gap-2">Buscar Suscripción</button> </form> <div id="renewal-results" class="mt-6 text-left space-y-3 empty:hidden"></div> </div> `);
        };
        window.searchRenewal = (e) => { e.preventDefault(); const emailQuery = document.getElementById('renew-email').value.trim().toLowerCase(); const container = document.getElementById('renewal-results'); container.innerHTML = '<div class="text-center py-4"><span class="animate-spin inline-block w-5 h-5 border-2 border-indigo-500 border-t-transparent rounded-full"></span></div>'; const matches = window.userTransactions.filter(t => t.type === 'purchase' && t.details && t.details.email && t.details.email.toLowerCase() === emailQuery); if (matches.length === 0) { container.innerHTML = ` <div class="neumo-card neumo-inset p-4 rounded-xl text-center animate-pulse" style="border-left: 4px solid var(--color-danger);"> <p class="text-xs font-bold text-danger mb-1">No encontrado</p> <p class="text-[10px] text-gray-500">No tienes compras registradas con este correo.</p> </div>`; } else { let html = ''; matches.forEach(m => { const platformName = m.details.serviceName || m.description.replace('Compra: ', ''); html += ` <div class="neumo-card p-4 rounded-2xl shadow-sm flex flex-col gap-3 slide-up"> <div class="flex justify-between items-start"> <div> <p class="font-black text-gray-800 text-sm">${platformName}</p> <p class="text-[10px] text-gray-400 font-mono mt-0.5">${m.details.email}</p> </div> <span class="bg-indigo-50/50 text-indigo-600 text-[10px] font-bold px-2 py-1 rounded-lg neumo-flat">Renovable: SÍ</span> </div> <div class="flex gap-2 mt-1"> <button onclick="requestRenewal('${m.id}', '${platformName}', '${m.details.email}')" class="neumo-button flex-1 bg-gray-900 text-white py-2.5 rounded-xl text-xs font-bold hover:bg-gray-800">Solicitar Renovación</button> </div> </div> `; }); container.innerHTML = html; lucide.createIcons(); } };
        window.requestRenewal = async (txId, platform, email) => { if(!confirm(`¿Solicitar renovación para ${platform}?`)) return; try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), { uid: currentUser.uid, email: currentUser.email, type: 'renewal', description: `Solicitud de renovación para: ${platform}\nCuenta: ${email}\nID Compra Original: ${txId}`, timestamp: serverTimestamp(), status: 'unread' }); showToast('Solicitud enviada al administrador', 'success'); closeModal(); } catch (e) { showToast('Error al solicitar', 'error'); } };

        // --- UTILIDADES UI ---
        window.toggleSidebar = () => { const s=document.getElementById('sidebar'); const o=document.getElementById('sidebar-overlay'); if(s.classList.contains('-translate-x-full')){s.classList.remove('-translate-x-full');o.classList.remove('opacity-0','pointer-events-none');}else{s.classList.add('-translate-x-full');o.classList.add('opacity-0','pointer-events-none');} } 
        window.switchView = (v) => { const u=document.getElementById('user-view'); const a=document.getElementById('admin-view'); if(v==='admin'){u.classList.add('hidden');a.classList.remove('hidden');}else{a.classList.add('hidden');u.classList.remove('hidden');} }
        window.showToast = (m,t='info') => {const c=document.getElementById('toast-container');const el=document.createElement('div');const col={success:'bg-success text-white',error:'bg-danger text-white',info:'bg-gray-800 text-white'};el.className=`${col[t]} px-4 py-3 rounded-xl shadow-xl flex items-center gap-3 text-sm font-bold transform transition-all duration-300 translate-x-full pointer-events-auto border border-white/10 backdrop-blur-md`;el.innerHTML=`<span>${m}</span>`;c.appendChild(el);requestAnimationFrame(()=>el.classList.remove('translate-x-full'));setTimeout(()=>{el.classList.add('translate-x-full','opacity-0');setTimeout(()=>el.remove(),300);},3000);}
        window.closeModal = () => { const m=document.getElementById('app-modal'); m.classList.add('hidden'); m.classList.remove('flex'); };
        window.openModal = (h) => { document.getElementById('modal-content').innerHTML=h; const m=document.getElementById('app-modal'); m.classList.remove('hidden'); m.classList.add('flex'); lucide.createIcons(); };
        window.enterAdminModule = (m) => { document.getElementById('admin-dashboard-grid').classList.add('hidden'); document.getElementById('admin-modules-container').classList.remove('hidden'); document.querySelectorAll('section[id^="admin-"]').forEach(s=>s.classList.add('hidden')); document.getElementById(`admin-${m}-section`).classList.remove('hidden'); };
        window.returnToAdminDashboard = () => { document.getElementById('admin-dashboard-grid').classList.remove('hidden'); document.getElementById('admin-modules-container').classList.add('hidden'); };
        window.switchAuthView = (v) => { document.querySelectorAll('.auth-view').forEach(x=>x.classList.add('hidden')); document.getElementById(`${v==='login'?'login':v==='register'?'register':'forgot'}-form`).classList.remove('hidden'); };
        
        window.approveRecharge = async (reqId, uid, amt, txId) => { 
            if(!confirm('¿Aprobar saldo de $' + amt + '?')) return; 
            const wRef = doc(db, 'artifacts', appId, 'users', uid, 'wallet', 'main'); 
            try {
                await runTransaction(db, async (t) => { 
                    const s = await t.get(wRef); 
                    const currentBal = Number(s.exists() ? s.data().balance : 0) || 0;
                    t.update(wRef, { balance: currentBal + Number(amt) }); 
                }); 
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pending_recharges', reqId), { status: 'approved' }); 
                if(txId) { await updateDoc(doc(db, 'artifacts', appId, 'users', uid, 'transactions', txId), { status: 'Éxito' }); }
                showToast('Saldo cargado correctamente', 'success'); 
            } catch(e) { console.error(e); showToast('Error al aprobar', 'error'); }
        };
        
        // --- RECHAZAR RECARGA (NUEVO) ---
        window.rejectRecharge = async (reqId, uid, txId) => {
            if(!confirm('¿Rechazar esta solicitud de recarga?')) return;
            try {
                // Actualizar solicitud pública
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pending_recharges', reqId), { status: 'rejected' });
                
                // Actualizar transacción del usuario
                if(txId) { 
                    await updateDoc(doc(db, 'artifacts', appId, 'users', uid, 'transactions', txId), { 
                        status: 'Rechazado',
                        description: 'Recarga Rechazada por Admin'
                    }); 
                }
                showToast('Solicitud rechazada', 'info');
            } catch(e) { 
                console.error(e); 
                showToast('Error al rechazar', 'error'); 
            }
        };

        window.deleteProfile = async (id) => { if(confirm("¿Borrar producto?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', id)); };

        document.getElementById('login-form').addEventListener('submit', async(e)=>{
            e.preventDefault(); 
            try {
                const credential = await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); 
                if (!credential.user.emailVerified) { await signOut(auth); showToast('📧 Por favor verifica tu correo electrónico.', 'error'); return; }
                showToast('Bienvenido', 'success');
            } catch(e) { showToast('Error al iniciar sesión', 'error'); }
        });
        
        document.getElementById('register-form').addEventListener('submit', async(e)=>{
            e.preventDefault(); 
            const btn = document.querySelector('#register-form button'); const originalText = btn.innerText; btn.disabled = true; btn.innerText = 'Creando cuenta...';
            const p1=document.getElementById('reg-password').value; 
            const p2=document.getElementById('reg-confirm-password').value; 
            const email = document.getElementById('reg-email').value;
            if(p1!==p2) { btn.disabled=false; btn.innerText=originalText; return showToast('Contraseñas no coinciden','error'); }
            const urlParams = new URLSearchParams(window.location.search); const referrerId = urlParams.get('ref');

            try{
                const c = await createUserWithEmailAndPassword(auth, email, p1); 
                const uid = c.user.uid;
                await sendEmailVerification(c.user);

                if(referrerId) {
                    try {
                        await runTransaction(db, async (t) => {
                            const resellerWalletRef = doc(db, 'artifacts', appId, 'users', referrerId, 'wallet', 'main');
                            const resellerSnap = await t.get(resellerWalletRef);
                            if (!resellerSnap.exists()) throw new Error("Revendedor inválido");
                            const resellerBalance = resellerSnap.data().balance || 0;
                            if (resellerBalance < 40) throw new Error("Revendedor sin saldo");

                            t.update(resellerWalletRef, { balance: resellerBalance - 40 });
                            const newWalletRef = doc(db,'artifacts',appId,'users',uid,'wallet','main');
                            t.set(newWalletRef, { balance: 40, profit: 0, createdAt: serverTimestamp() });
                            const newUserProfileRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', uid);
                            t.set(newUserProfileRef, { email: email, uid: uid, role: 'client', referredBy: referrerId, suspended: false, lastLogin: serverTimestamp() }, {merge: true});
                            const resellerTx = doc(collection(db, 'artifacts', appId, 'users', referrerId, 'transactions'));
                            t.set(resellerTx, { type: 'charge', amount: -40, description: `Bono bienvenida referido: ${email}`, timestamp: serverTimestamp() });
                            const newUserTx = doc(collection(db, 'artifacts', appId, 'users', uid, 'transactions'));
                            t.set(newUserTx, { type: 'deposit', amount: 40, description: 'Bono de Bienvenida', timestamp: serverTimestamp(), status: 'approved' });
                        });
                    } catch (txError) {
                        await setDoc(doc(db,'artifacts',appId,'users',uid,'wallet','main'),{balance:0,profit:0}); 
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', uid), { email: email, uid: uid, role: 'client', suspended: false, lastLogin: serverTimestamp() }, {merge: true});
                    }
                } else {
                    await setDoc(doc(db,'artifacts',appId,'users',uid,'wallet','main'),{balance:0,profit:0}); 
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', uid), { email: email, uid: uid, role: 'client', suspended: false, lastLogin: serverTimestamp() }, {merge: true});
                }
                
                await signOut(auth);
                document.getElementById('reg-email').value = ''; document.getElementById('reg-password').value = ''; document.getElementById('reg-confirm-password').value = '';
                showToast('¡Registro exitoso! 📩 Verifica tu correo.', 'success');
                switchAuthView('login');
                btn.disabled=false; btn.innerText=originalText;
            }catch(e){ showToast('Error en registro', 'error'); btn.disabled=false; btn.innerText=originalText; }
        });
        
        window.handleLogout = async () => { await signOut(auth); document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('login-email').value = ''; document.getElementById('login-password').value = ''; };
        document.addEventListener('DOMContentLoaded', () => { lucide.createIcons(); checkReferralParam(); });
    </script>
</body>
</html>
